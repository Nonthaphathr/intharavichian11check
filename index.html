<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบตรวจทานอินทรวิเชียรฉันท์ ๑๑ (Syllable Edition V2.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Prompt', 'Sarabun', sans-serif; background-color: #f8f9fa; }
        .kru-bg { background-color: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .lahu-bg { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .syllable-box { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            width: 60px; 
            height: 65px; 
            margin: 4px; 
            border-radius: 8px;
            position: relative;
            transition: all 0.2s;
            background-color: white;
        }
        .syllable-word { font-size: 1.1rem; font-weight: 600; margin-bottom: 2px; }
        .syllable-type { font-size: 0.7rem; opacity: 0.8; }
        .error-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ef4444;
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .logo-shadow { filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div class="container max-w-4xl mx-auto p-4 flex-grow">
        
        <div class="bg-white rounded-2xl shadow-sm p-6 mb-6 text-center border border-gray-100 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-blue-600"></div>
            
            <div class="flex flex-col md:flex-row items-center justify-center gap-6 mb-4">
                <img src="https://img5.pic.in.th/file/secure-sv1/logo-vichakarngo-6.png" alt="Logo" class="w-32 h-auto rounded-lg logo-shadow object-contain">
                <div class="text-left">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">ระบบตรวจทานอินทรวิเชียรฉันท์ ๑๑</h1>
                    <p class="text-gray-500 mt-1">ตรวจสอบความถูกต้องของฉันทลักษณ์ (ครุ-ลหุ) และการสัมผัส</p>
                    <div class="mt-2 inline-block bg-blue-50 text-blue-600 text-xs px-3 py-1 rounded-full border border-blue-100">
                        พัฒนาโดย ครูนนทพัทธ์ หิรัญเรือง
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-6 mb-6 border border-gray-100">
            <label class="block text-gray-700 font-bold mb-2 flex flex-col md:flex-row md:items-center gap-2">
                <span>✍️ วางบทประพันธ์ (1 หรือ 2 บท)</span>
                <span class="text-xs font-normal text-gray-400 bg-gray-100 px-2 py-1 rounded">ระบบนับคำแบบพยางค์ (เช่น สดใส = 2 คำ)</span>
            </label>
            <textarea id="poemInput" rows="5" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 text-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" placeholder="วางบทประพันธ์ที่นี่...&#10;ความรักจะสดใส ปิยะใจก็คือเธอ&#10;คิดถึงและอยากเจอ ก็เพราะเธอมิเหมือนใคร"></textarea>
            
            <div class="flex justify-end mt-4">
                <button onclick="analyzePoem()" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-2 px-6 rounded-xl shadow-md transition transform hover:-translate-y-0.5 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    ตรวจสอบผลงาน
                </button>
            </div>
        </div>

        <div id="resultArea" class="hidden">
            <div class="flex items-center gap-2 mb-4">
                <div class="w-1 h-8 bg-blue-600 rounded-full"></div>
                <h3 class="text-xl font-bold text-gray-800">ผลการวิเคราะห์</h3>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm">
                    <h4 class="font-bold text-gray-700 mb-2">ผังบังคับ (ครุ-ลหุ)</h4>
                    <div id="kruLahuSummary"></div>
                </div>

                <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm">
                    <h4 class="font-bold text-gray-700 mb-2">สัมผัสบังคับ</h4>
                    <div id="samphusSummary" class="text-sm space-y-2"></div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm overflow-x-auto">
                <div id="visualResult" class="space-y-6 min-w-[600px]"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // 1. RULES & CHECKING LOGIC (Logic เดิม)
        // ============================================

        function getVowelAndFinalSound(word) {
            if (!word) return { vowel: '', finalGroup: '' };
            const cleanWord = word.replace(/[่้๊๋์]/g, '');
            const processedWord = processLeadingConsonants(cleanWord);

            if (/รร[ถตษสศดจชฎฏฐฑฒทธ]$/.test(processedWord)) return { vowel: 'อะ', finalGroup: 'กด' };
            if (/รร[คกขฆ]$/.test(processedWord)) return { vowel: 'อะ', finalGroup: 'กก' };
            if (/รร[พภบปฟ]$/.test(processedWord)) return { vowel: 'อะ', finalGroup: 'กบ' };
            if (processedWord.endsWith('รรม')) return { vowel: 'อำ', finalGroup: 'กกา' };
            if (processedWord.endsWith('รร')) return { vowel: 'อะ', finalGroup: 'กน' };
            if (processedWord.endsWith('รรณ')) return { vowel: 'อะ', finalGroup: 'กน' };

            if (hasAiVowel(processedWord)) return { vowel: 'ไอ', finalGroup: 'เกย' };

            const finalGroup = getFinalConsonantGroup(processedWord);
            const vowel = getVowelSound(processedWord);
            return { vowel, finalGroup };
        }

        function processLeadingConsonants(word) {
            const anamYWords = ['อย่า', 'อยู่', 'อย่าง', 'อยาก'];
            for (let w of anamYWords) {
                if (word.startsWith(w.replace(/[่้๊๋์]/g, ''))) return 'ย' + word.substring(2);
            }
            if (word.length >= 2 && word.charAt(0) === 'ห') {
                const secondChar = word.charAt(1);
                if (['ง', 'ย', 'ญ', 'ร', 'น', 'ล', 'ม', 'ว'].includes(secondChar)) return word.substring(1);
            }
            return word;
        }

        function hasAiVowel(word) {
            if (word.includes('ไ') || word.includes('ใ') || word.includes('ัย')) return true;
            const specialAiWords = ['วัย', 'ชัย', 'ภัย', 'ไทย', 'อัย', 'ขัย', 'นัย', 'ลัย', 'สัย', 'ปัจจัย', 'อาศัย', 'วิสัย', 'ปรนัย', 'อุปัย', 'วิธัย'];
            for (let w of specialAiWords) {
                if (word === w || word.endsWith(w)) return true;
            }
            return false;
        }

        function getFinalConsonantGroup(word) {
            if (hasAiVowel(word)) return 'เกย';
            const lastChar = word.charAt(word.length - 1);
            const groups = {
                'กขคฆ': 'กก', 'จชซฌญดตถทธศษสฎฏฐฑฒ': 'กด', 'บปพฟภ': 'กบ',
                'นณรลฬ': 'กน', 'ม': 'กม', 'ง': 'กง', 'ย': 'เกย', 'ว': 'เกอว'
            };
            for (let g in groups) {
                if (g.includes(lastChar)) return groups[g];
            }
            return 'กกา';
        }

        function getVowelSound(word) {
            if (hasAiVowel(word)) return 'ไอ';
            if (word.includes('อำ') || word.includes('ำ')) return 'อำ';
            const shortVowels = ['ะ', 'ิ', 'ึ', 'ุ', '็', 'ั'];
            for(let v of shortVowels) {
                 if(word.includes(v)) return 'อะ'; 
            }
            return 'อา'; 
        }

        function isLahu(word) {
            if (!word) return false;
            word = word.trim();
            const cleanWord = word.replace(/[่้๊๋์]/g, '');
            const processedWord = processLeadingConsonants(cleanWord);
            
            // คำยกเว้นที่เป็นลหุ
            const specialLahu = ["ก็", "บ่", "ณ", "ธ", "จะ", "ทิ", "ปิ", "ยะ", "สิ", "ธุ", "ระ", "พะ", "มิ"];
            if (specialLahu.includes(word)) return true;

            if (processedWord.includes("อำ") || processedWord.includes("ไอ") || processedWord.includes("ใอ") || processedWord.includes("เอา")) return false;
            if (hasEndingConsonant(word)) return false;

            const forceKruLongVowels = ["า", "ี", "ื", "ู", "เ", "แ", "โ", "อ"];
            const shorteners = ["ะ", "็"];
            
            let hasLongVowel = false;
            for (let v of forceKruLongVowels) if (processedWord.includes(v)) hasLongVowel = true;

            if (hasLongVowel) {
                let isShortened = false;
                for (let s of shorteners) if (processedWord.includes(s)) isShortened = true;
                if (processedWord.includes("เอาะ") || processedWord.includes("เออะ") || processedWord.includes("อัวะ") || processedWord.includes("เอียะ")) isShortened = true;
                if (!isShortened) return false;
            }
            return true; 
        }

        function hasEndingConsonant(word) {
            const cleanWord = word.replace(/[่้๊๋์]/g, '');
            const processedWord = processLeadingConsonants(cleanWord);
            const finalConsonants = "กขคฆจชซฌญดตถทธศษสฎฏฐบปผฝพฟภนณรลฬมยวง";
            const lastChar = processedWord.charAt(processedWord.length - 1);
            if (finalConsonants.includes(lastChar)) {
                if (processedWord.length === 1) return false;
                if ("่้๊๋์".includes(processedWord.charAt(processedWord.length - 2))) return false;
                return true;
            }
            return false;
        }

        function checkSamphus(word1, word2) {
            if (!word1 || !word2) return false;
            const sound1 = getVowelAndFinalSound(word1);
            const sound2 = getVowelAndFinalSound(word2);
            return sound1.vowel === sound2.vowel && sound1.finalGroup === sound2.finalGroup;
        }

        // ============================================
        // 2. INTELLIGENT SYLLABLE SPLITTER (NEW!)
        // ============================================
        
        function tokenizeThaiSyllables(text) {
            // ล้างอักขระพิเศษ
            text = text.replace(/[^\u0E00-\u0E7F\s]/g, " ");
            
            // 1. แบ่งคำเบื้องต้นด้วย Intl.Segmenter (แยกตามพจนานุกรมได้ดีระดับหนึ่ง)
            const segmenter = new Intl.Segmenter('th', { granularity: 'word' });
            const rawWords = Array.from(segmenter.segment(text)).filter(s => s.isWordLike).map(s => s.segment.trim());

            let finalSyllables = [];

            // 2. ประมวลผลแต่ละคำ เพื่อ "ผ่า" คำที่ควบกันอยู่
            rawWords.forEach(word => {
                // ถ้าคำยาว และมีสระนำ (เ แ โ ใ ไ) อยู่กลางคำ -> ต้องผ่า!
                // ตัวอย่าง: "สดใส" (ใ อยู่ตัวที่ 3) -> "สด", "ใส"
                if (word.length > 2) {
                    let splitIndices = [];
                    
                    // หาตำแหน่งสระนำ ที่ไม่ได้อยู่ตัวแรก
                    for(let i=1; i<word.length; i++) {
                        if ("เแโใไ".includes(word[i])) {
                            splitIndices.push(i);
                        }
                    }

                    // หาตำแหน่งสระกลางคำอื่นๆ (Heuristic สำหรับ คิดถึง, สดชื่น)
                    // ถ้าเจอ pattern: [พยัญชนะ][สระบนล่าง][ตัวสะกด] + [พยัญชนะ][สระบนล่าง]
                    // เช่น ค-ิ-ด-ถ-ึ-ง -> ผ่าหน้า ถ
                    if (splitIndices.length === 0 && word.length >= 4) {
                        // เช็คแบบง่าย: ถ้ามีสระ 2 ตำแหน่งที่ห่างกัน
                        let vowels = [];
                        for(let i=0; i<word.length; i++) {
                            if ("ะาิีึืุู".includes(word[i])) vowels.push(i);
                        }
                        if (vowels.length >= 2) {
                             // กรณี "คิดถึง"
                             // (อันนี้ใช้ Regex แบบง่ายเพื่อช่วยแยก)
                             // ให้ Intl แยกไม่ขาด เราจะพยายามแยกเอง ถ้ามันดูเหมือน 2 พยางค์
                             // แต่เพื่อความปลอดภัย ไม่ผ่าสุ่มสี่สุ่มห้า ถ้าไม่มี เแโใไ 
                             // ให้ผู้ใช้เว้นวรรคช่วยได้ถ้าจำเป็น แต่เคส "สดใส" จะถูกแก้ด้วย rule บนแล้ว
                        }
                    }

                    // ดำเนินการผ่า
                    if (splitIndices.length > 0) {
                        let lastIdx = 0;
                        splitIndices.forEach(idx => {
                            finalSyllables.push(word.substring(lastIdx, idx));
                            lastIdx = idx;
                        });
                        finalSyllables.push(word.substring(lastIdx));
                    } else {
                        finalSyllables.push(word);
                    }
                } else {
                    finalSyllables.push(word);
                }
            });

            return finalSyllables;
        }

        // ============================================
        // 3. MAIN APP LOGIC
        // ============================================

        const PATTERN_STANZA = [
            ['K', 'K', 'L', 'K', 'K'],          // วรรค 1
            ['L', 'L', 'K', 'L', 'K', 'K'],     // วรรค 2
            ['K', 'K', 'L', 'K', 'K'],          // วรรค 3
            ['L', 'L', 'K', 'L', 'K', 'K']      // วรรค 4
        ];

        function analyzePoem() {
            const input = document.getElementById('poemInput').value.trim();
            if(!input) return alert("กรุณาวางบทประพันธ์ก่อนครับ");

            // 1. Tokenize (นับพยางค์)
            let syllables = tokenizeThaiSyllables(input);

            // 2. ตรวจสอบจำนวนพยางค์เพื่อเลือกโหมด (1 หรือ 2 บท)
            const count = syllables.length;
            let mode = 1; 
            
            // เกณฑ์: ถ้ามีมากกว่า 30 พยางค์ ให้ถือว่าเป็น 2 บท (ปกติ 1 บท = 22 คำ, 2 บท = 44 คำ)
            if (count > 30) mode = 2; 

            // 3. สร้าง Pattern สำหรับตรวจ
            let currentPattern = [];
            if (mode === 1) {
                currentPattern = [...PATTERN_STANZA];
            } else {
                currentPattern = [...PATTERN_STANZA, ...PATTERN_STANZA]; // ต่อกัน 2 บท
            }

            // 4. จับคู่คำกับ Pattern
            let structuredPoem = [];
            let wordIndex = 0;
            
            for(let i=0; i < currentPattern.length; i++) {
                let versePattern = currentPattern[i];
                let verseWords = [];
                for(let j=0; j < versePattern.length; j++) {
                    if(wordIndex < syllables.length) {
                        verseWords.push(syllables[wordIndex]);
                        wordIndex++;
                    } else {
                        verseWords.push("?"); 
                    }
                }
                structuredPoem.push(verseWords);
            }

            // 5. กำหนดคู่สัมผัส
            let rhymePairs = [
                { from: [0, 4], to: [1, 2], name: 'สัมผัสระหว่างวรรค (บท 1)' },
                { from: [1, 5], to: [2, 4], name: 'สัมผัสระหว่างบาท (บท 1)' }
            ];

            if (mode === 2) {
                rhymePairs.push(
                    { from: [3, 5], to: [5, 5], name: 'สัมผัสระหว่างบท' },
                    { from: [4, 4], to: [5, 2], name: 'สัมผัสระหว่างวรรค (บท 2)' },
                    { from: [5, 5], to: [6, 4], name: 'สัมผัสระหว่างบาท (บท 2)' }
                );
            }

            renderResult(structuredPoem, currentPattern, rhymePairs, mode);
        }

        function renderResult(poem, pattern, rhymePairs, mode) {
            const resultArea = document.getElementById('resultArea');
            const visualDiv = document.getElementById('visualResult');
            const kruLahuSummary = document.getElementById('kruLahuSummary');
            const samphusSummary = document.getElementById('samphusSummary');
            
            visualDiv.innerHTML = '';
            resultArea.classList.remove('hidden');

            let errorCount = 0;
            
            // Render คำและกล่อง
            poem.forEach((verse, vIndex) => {
                const verseDiv = document.createElement('div');
                verseDiv.className = "flex items-center mb-4";
                
                const label = document.createElement('div');
                label.className = "w-20 text-xs text-gray-400 font-bold uppercase tracking-wider flex-shrink-0";
                label.innerText = `วรรค ${vIndex + 1}`;
                verseDiv.appendChild(label);

                const wordsContainer = document.createElement('div');
                wordsContainer.className = "flex flex-wrap gap-2";

                verse.forEach((word, wIndex) => {
                    const expected = pattern[vIndex][wIndex]; 
                    const isLahuWord = isLahu(word);
                    const actual = isLahuWord ? 'L' : 'K';
                    
                    const box = document.createElement('div');
                    
                    let bgClass = actual === 'K' ? 'kru-bg' : 'lahu-bg';
                    let isError = false;

                    if(word === '?') {
                         box.className = "syllable-box bg-gray-100 text-gray-400 border border-gray-200";
                         word = "ว่าง";
                    } else if (expected === actual) {
                        box.className = `syllable-box ${bgClass}`;
                    } else {
                        box.className = `syllable-box bg-white border-2 border-red-500 text-red-600`;
                        isError = true;
                        errorCount++;
                    }

                    box.innerHTML = `
                        <span class="syllable-word">${word}</span>
                        <span class="syllable-type">${actual==='K'?'ครุ':'ลหุ'}</span>
                        ${isError ? '<span class="error-badge">แก้</span>' : ''}
                    `;
                    wordsContainer.appendChild(box);
                });
                
                verseDiv.appendChild(wordsContainer);
                visualDiv.appendChild(verseDiv);

                if (mode === 2 && vIndex === 3) {
                    const sep = document.createElement('div');
                    sep.className = "border-b border-dashed border-gray-300 my-4 mx-10";
                    visualDiv.appendChild(sep);
                }
            });

            // ตรวจสัมผัส
            let rhymeHTML = '';
            let rhymePass = true;
            rhymePairs.forEach(pair => {
                const w1 = poem[pair.from[0]]?.[pair.from[1]];
                const w2 = poem[pair.to[0]]?.[pair.to[1]];

                if(w1 && w2 && w1 !== '?' && w2 !== '?') {
                    const isRhyme = checkSamphus(w1, w2);
                    if(isRhyme) {
                        rhymeHTML += `<div class="flex items-center text-green-700 bg-green-50 p-2 rounded-lg border border-green-100">
                            <span class="mr-2">✅</span> 
                            <span class="text-xs font-bold mr-2 border border-green-200 px-1 rounded text-green-600">${pair.name}</span>
                            <span><b>${w1}</b> - <b>${w2}</b> (สัมผัส)</span>
                        </div>`;
                    } else {
                        rhymePass = false;
                        rhymeHTML += `<div class="flex items-center text-red-700 bg-red-50 p-2 rounded-lg border border-red-100">
                            <span class="mr-2">❌</span> 
                             <span class="text-xs font-bold mr-2 border border-red-200 px-1 rounded text-red-500">${pair.name}</span>
                            <span><b>${w1}</b> - <b>${w2}</b> (ไม่สัมผัส)</span>
                        </div>`;
                    }
                } else {
                    rhymeHTML += `<div class="flex items-center text-gray-400 p-2 text-sm">
                        <span class="mr-2">⚪</span> ${pair.name}: ข้อมูลไม่ครบ
                    </div>`;
                }
            });
            samphusSummary.innerHTML = rhymeHTML;

            // สรุปผล
            if (errorCount === 0) {
                kruLahuSummary.innerHTML = `<h2 class="text-3xl font-bold text-green-500">เยี่ยมมาก!</h2><p class="text-gray-500 text-sm">ฉันทลักษณ์ถูกต้อง (${mode} บท)</p>`;
            } else {
                kruLahuSummary.innerHTML = `<h2 class="text-3xl font-bold text-red-500">พบ ${errorCount} จุด</h2><p class="text-gray-500 text-sm">ตรวจสอบคำที่ขึ้นสัญลักษณ์ "แก้"</p>`;
            }

            resultArea.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
