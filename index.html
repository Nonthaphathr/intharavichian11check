<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏â‡∏±‡∏ô‡∏ó‡πå ‡πë‡πë (V2.7 Final Polish)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Prompt', 'Sarabun', sans-serif; background-color: #f0f4f8; }
        .kru-bg { background-color: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .lahu-bg { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .syllable-box { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            width: 60px; 
            height: 65px; 
            margin: 4px; 
            border-radius: 8px;
            position: relative;
            transition: all 0.2s;
            background-color: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .empty-box {
            background-color: #f3f4f6;
            border: 2px dashed #d1d5db;
            color: #9ca3af;
        }
        .syllable-word { font-size: 1.1rem; font-weight: 600; margin-bottom: 2px; }
        .syllable-type { font-size: 0.7rem; opacity: 0.8; }
        .badge {
            position: absolute;
            top: -6px;
            right: -6px;
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .badge-error { background-color: #ef4444; }
        
        .extra-word {
            display: inline-block;
            background-color: #fee2e2;
            color: #b91c1c;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            border: 1px solid #fca5a5;
            margin-right: 4px;
        }
        .logo-shadow { filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }

        /* Button Animation */
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .btn-animate {
            animation: pulse-ring 2s infinite;
        }
        .btn-animate:hover {
            animation: none;
            transform: scale(1.05);
            transition: transform 0.2s ease;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div class="container max-w-4xl mx-auto p-4 flex-grow">
        
        <div class="bg-white rounded-2xl shadow-sm p-6 mb-6 text-center border border-gray-100 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
            <div class="flex flex-col md:flex-row items-center justify-center gap-6 mb-4">
                <img src="https://img5.pic.in.th/file/secure-sv1/logo-vichakarngo-6.png" alt="Logo" class="w-32 h-auto rounded-lg logo-shadow object-contain">
                <div class="text-left">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏â‡∏±‡∏ô‡∏ó‡πå ‡πë‡πë</h1>
                    <p class="text-gray-500 mt-1">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏ó‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå (‡∏Ñ‡∏£‡∏∏-‡∏•‡∏´‡∏∏) ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™</p>
                    <div class="mt-2 inline-block bg-indigo-50 text-indigo-600 text-xs px-3 py-1 rounded-full border border-indigo-100 font-medium">
                        ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-6 mb-6 border border-gray-100">
            <label class="block text-gray-700 font-bold mb-2 flex flex-col md:flex-row md:items-center justify-between gap-2">
                <span class="flex items-center gap-2 text-lg">üìù ‡∏ß‡∏≤‡∏á‡∏ö‡∏ó‡∏õ‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡πå (‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)</span>
                <span class="text-xs font-normal text-gray-500 bg-gray-100 px-3 py-1 rounded-full">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏µ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (Line-by-Line)</span>
            </label>
            
            <textarea id="poemInput" rows="6" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 text-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 transition placeholder-gray-400" placeholder="‡∏ß‡∏≤‡∏á‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏â‡∏±‡∏ô‡∏ó‡πå ‡πë‡πë ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡∏ô‡∏µ‡πà  
‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á : 
‡∏¢‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ö‡∏≤‡∏¢‡πÉ‡∏à               
‡∏à‡∏∞‡∏™‡∏ô‡∏∏‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏£‡∏∑‡πà‡∏ô‡∏ä‡∏π
‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏¥‡∏ï‡∏£‡∏™‡∏¥‡∏´‡∏î‡∏´‡∏π‡πà                      
‡∏°‡∏¥‡∏•‡∏∞‡∏´‡πà‡∏≤‡∏á ‡∏§ ‡∏´‡∏≤‡∏¢‡∏´‡∏ô‡∏µ"></textarea>
            
            <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4 flex flex-col md:flex-row gap-4 items-start shadow-sm">
                <div class="flex-shrink-0 mt-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="flex-grow">
                    <h4 class="font-bold text-gray-800 text-sm mb-2">üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏´‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏û‡∏¢‡∏≤‡∏á‡∏Ñ‡πå‡∏ú‡∏¥‡∏î (‡∏£‡∏ß‡∏ö‡∏Ñ‡∏≥)</h4>
                    <p class="text-sm text-gray-600 mb-3">
                        ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏ß‡∏ö‡πÄ‡∏õ‡πá‡∏ô 1 ‡∏Ñ‡∏≥ ‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô <b>"‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏ß‡∏£‡∏£‡∏Ñ"</b> ‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ô‡∏±‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å‡∏û‡∏¢‡∏≤‡∏á‡∏Ñ‡πå
                    </p>
                    <div class="bg-white border border-gray-200 rounded-lg p-3 text-sm flex flex-wrap gap-4 items-center shadow-inner">
                        <div class="text-red-500 flex items-center gap-2">
                            <span class="font-bold">‚ùå ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏ß‡∏ö‡∏ú‡∏¥‡∏î:</span>
                            <span class="bg-red-50 px-2 py-1 rounded border border-red-100 font-mono">‡∏ï‡∏≤‡∏Å‡∏•‡∏°</span>
                            <span class="text-xs text-gray-400">(‡∏ô‡∏±‡∏ö 1 ‡∏Ñ‡∏≥)</span>
                        </div>
                        <div class="text-gray-300">‚ûú</div>
                        <div class="text-green-600 flex items-center gap-2">
                            <span class="font-bold">‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ (‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏ß‡∏£‡∏£‡∏Ñ):</span>
                            <span class="bg-green-50 px-2 py-1 rounded border border-green-100 ring-2 ring-green-100 font-mono">‡∏ï‡∏≤ ‡∏Å‡∏•‡∏°</span>
                            <span class="text-xs text-gray-400">(‡∏ô‡∏±‡∏ö 2 ‡∏Ñ‡∏≥)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end mt-6">
                <button onclick="analyzePoem()" class="btn-animate bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-3 px-8 rounded-full shadow-lg flex items-center gap-3 text-lg cursor-pointer transform transition hover:-translate-y-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏á‡∏≤‡∏ô
                </button>
            </div>
        </div>

        <div id="resultArea" class="hidden animate-fade-in-up">
            <div class="flex items-center gap-2 mb-4">
                <div class="w-1.5 h-8 bg-indigo-600 rounded-full"></div>
                <h3 class="text-xl font-bold text-gray-800">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition">
                    <h4 class="font-bold text-gray-700 mb-2 border-b border-gray-100 pb-2">‡∏ú‡∏±‡∏á‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö (‡∏Ñ‡∏£‡∏∏-‡∏•‡∏´‡∏∏)</h4>
                    <div id="kruLahuSummary"></div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition">
                    <h4 class="font-bold text-gray-700 mb-2 border-b border-gray-100 pb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥ (‡∏Ç‡∏≤‡∏î/‡πÄ‡∏Å‡∏¥‡∏ô)</h4>
                    <div id="wordCountSummary"></div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition">
                    <h4 class="font-bold text-gray-700 mb-2 border-b border-gray-100 pb-2">‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö</h4>
                    <div id="samphusSummary" class="text-sm space-y-2"></div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm overflow-x-auto hover:shadow-md transition">
                <div id="visualResult" class="space-y-6 min-w-[600px]"></div>
            </div>
        </div>
    </div>

    <script>
        // ----------------------------------------------------
        // 1. HELPER FUNCTIONS
        // ----------------------------------------------------

        function processLeadingConsonants(word) {
            const anamYWords = ['‡∏≠‡∏¢‡πà‡∏≤', '‡∏≠‡∏¢‡∏π‡πà', '‡∏≠‡∏¢‡πà‡∏≤‡∏á', '‡∏≠‡∏¢‡∏≤‡∏Å'];
            for (let w of anamYWords) if (word.startsWith(w.replace(/[‡πà‡πâ‡πä‡πã‡πå]/g, ''))) return '‡∏¢' + word.substring(2);
            if (word.length >= 2 && word.charAt(0) === '‡∏´' && ['‡∏á', '‡∏¢', '‡∏ç', '‡∏£', '‡∏ô', '‡∏•', '‡∏°', '‡∏ß'].includes(word.charAt(1))) return word.substring(1);
            return word;
        }

        function hasAiVowel(word) {
            if (word.includes('‡πÑ') || word.includes('‡πÉ') || word.includes('‡∏±‡∏¢')) return true;
            const specialAiWords = ['‡∏ß‡∏±‡∏¢', '‡∏ä‡∏±‡∏¢', '‡∏†‡∏±‡∏¢', '‡πÑ‡∏ó‡∏¢', '‡∏≠‡∏±‡∏¢', '‡∏Ç‡∏±‡∏¢', '‡∏ô‡∏±‡∏¢', '‡∏•‡∏±‡∏¢', '‡∏™‡∏±‡∏¢', '‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢', '‡∏≠‡∏≤‡∏®‡∏±‡∏¢', '‡∏ß‡∏¥‡∏™‡∏±‡∏¢', '‡∏õ‡∏£‡∏ô‡∏±‡∏¢', '‡∏≠‡∏∏‡∏õ‡∏±‡∏¢', '‡∏ß‡∏¥‡∏ò‡∏±‡∏¢'];
            for (let w of specialAiWords) if (word === w || word.endsWith(w)) return true;
            return false;
        }

        function getFinalConsonantGroup(word) {
            if (hasAiVowel(word)) return '‡πÄ‡∏Å‡∏¢';
            const lastChar = word.charAt(word.length - 1);
            const groups = {
                '‡∏Å‡∏Ç‡∏Ñ‡∏Ü': '‡∏Å‡∏Å', '‡∏à‡∏ä‡∏ã‡∏å‡∏ç‡∏î‡∏ï‡∏ñ‡∏ó‡∏ò‡∏®‡∏©‡∏™‡∏é‡∏è‡∏ê‡∏ë‡∏í': '‡∏Å‡∏î', '‡∏ö‡∏õ‡∏û‡∏ü‡∏†': '‡∏Å‡∏ö',
                '‡∏ô‡∏ì‡∏£‡∏•‡∏¨': '‡∏Å‡∏ô', '‡∏°': '‡∏Å‡∏°', '‡∏á': '‡∏Å‡∏á', '‡∏¢': '‡πÄ‡∏Å‡∏¢', '‡∏ß': '‡πÄ‡∏Å‡∏≠‡∏ß'
            };
            for (let g in groups) if (g.includes(lastChar)) return groups[g];
            return '‡∏Å‡∏Å‡∏≤';
        }

        function getVowelSound(word) {
            if (hasAiVowel(word)) return '‡πÑ‡∏≠';
            if (word.includes('‡∏≠‡∏≥') || word.includes('‡∏≥')) return '‡∏≠‡∏≥';
            const shortVowels = ['‡∏∞', '‡∏¥', '‡∏∂', '‡∏∏', '‡πá', '‡∏±'];
            for(let v of shortVowels) if(word.includes(v)) return '‡∏≠‡∏∞'; 
            return '‡∏≠‡∏≤'; 
        }

        function getVowelAndFinalSound(word) {
            if (!word) return { vowel: '', finalGroup: '' };
            const cleanWord = word.replace(/[‡πà‡πâ‡πä‡πã‡πå]/g, '');
            const processedWord = processLeadingConsonants(cleanWord);
            if (/‡∏£‡∏£[‡∏ñ‡∏ï‡∏©‡∏™‡∏®‡∏î‡∏à‡∏ä‡∏é‡∏è‡∏ê‡∏ë‡∏í‡∏ó‡∏ò]$/.test(processedWord)) return { vowel: '‡∏≠‡∏∞', finalGroup: '‡∏Å‡∏î' };
            if (/‡∏£‡∏£[‡∏Ñ‡∏Å‡∏Ç‡∏Ü]$/.test(processedWord)) return { vowel: '‡∏≠‡∏∞', finalGroup: '‡∏Å‡∏Å' };
            if (/‡∏£‡∏£[‡∏û‡∏†‡∏ö‡∏õ‡∏ü]$/.test(processedWord)) return { vowel: '‡∏≠‡∏∞', finalGroup: '‡∏Å‡∏ö' };
            if (processedWord.endsWith('‡∏£‡∏£‡∏°')) return { vowel: '‡∏≠‡∏≥', finalGroup: '‡∏Å‡∏Å‡∏≤' };
            if (processedWord.endsWith('‡∏£‡∏£')) return { vowel: '‡∏≠‡∏∞', finalGroup: '‡∏Å‡∏ô' };
            if (processedWord.endsWith('‡∏£‡∏£‡∏ì')) return { vowel: '‡∏≠‡∏∞', finalGroup: '‡∏Å‡∏ô' };
            if (hasAiVowel(processedWord)) return { vowel: '‡πÑ‡∏≠', finalGroup: '‡πÄ‡∏Å‡∏¢' };
            return { vowel: getVowelSound(processedWord), finalGroup: getFinalConsonantGroup(processedWord) };
        }

        function hasEndingConsonant(word) {
            const cleanWord = word.replace(/[‡πà‡πâ‡πä‡πã‡πå]/g, '');
            const processedWord = processLeadingConsonants(cleanWord);
            const finalConsonants = "‡∏Å‡∏Ç‡∏Ñ‡∏Ü‡∏à‡∏ä‡∏ã‡∏å‡∏ç‡∏î‡∏ï‡∏ñ‡∏ó‡∏ò‡∏®‡∏©‡∏™‡∏é‡∏è‡∏ê‡∏ö‡∏õ‡∏ú‡∏ù‡∏û‡∏ü‡∏†‡∏ô‡∏ì‡∏£‡∏•‡∏¨‡∏°‡∏¢‡∏ß‡∏á";
            const lastChar = processedWord.charAt(processedWord.length - 1);
            if (finalConsonants.includes(lastChar)) {
                if (processedWord.length === 1) return false;
                if ("‡πà‡πâ‡πä‡πã‡πå".includes(processedWord.charAt(processedWord.length - 2))) return false;
                return true;
            }
            return false;
        }

        // --- isLahu Logic (V2.6) ---
        function isLahu(word) {
            if (!word) return false;
            word = word.trim();
            const cleanWord = word.replace(/[‡πà‡πâ‡πä‡πã‡πå]/g, '');
            const processedWord = processLeadingConsonants(cleanWord);
            
            // 1. ‡∏Ñ‡∏≥‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô
            const specialLahu = ["‡∏Å‡πá", "‡∏ö‡πà", "‡∏ì", "‡∏ò", "‡∏à‡∏∞", "‡∏ó‡∏¥", "‡∏õ‡∏¥", "‡∏¢‡∏∞", "‡∏™‡∏¥", "‡∏ò‡∏∏", "‡∏£‡∏∞", "‡∏û‡∏∞", "‡∏°‡∏¥", "‡∏î‡∏∏", "‡πÄ‡∏ï‡∏∞", "‡∏Å‡∏∞", "‡∏ô‡∏¥", "‡∏ú‡∏•‡∏¥", "‡∏•‡∏∏", "‡∏§"];
            if (specialLahu.includes(word)) return true;

            // 2. ‡∏™‡∏£‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô -> ‡∏Ñ‡∏£‡∏∏
            if (processedWord.includes("‡∏≥") || processedWord.includes("‡πÑ") || processedWord.includes("‡πÉ")) return false; 
            if (processedWord.includes("‡πÄ") && processedWord.includes("‡∏≤")) return false;

            // 3. ‡∏ï‡∏±‡∏ß‡∏™‡∏∞‡∏Å‡∏î -> ‡∏Ñ‡∏£‡∏∏
            if (hasEndingConsonant(word)) return false;

            // 4. ‡∏™‡∏£‡∏∞‡∏¢‡∏≤‡∏ß -> ‡∏Ñ‡∏£‡∏∏
            const forceKruLongVowels = ["‡∏≤", "‡∏µ", "‡∏∑", "‡∏π", "‡πÄ", "‡πÅ", "‡πÇ", "‡∏≠"];
            let hasLongVowel = false;
            for (let v of forceKruLongVowels) if (processedWord.includes(v)) hasLongVowel = true;

            if (hasLongVowel) {
                const shorteners = ["‡∏∞", "‡πá"];
                let isShortened = false;
                for (let s of shorteners) if (processedWord.includes(s)) isShortened = true;
                if (processedWord.includes("‡πÄ‡∏≠‡∏≤‡∏∞") || processedWord.includes("‡πÄ‡∏≠‡∏≠‡∏∞") || processedWord.includes("‡∏≠‡∏±‡∏ß‡∏∞") || processedWord.includes("‡πÄ‡∏≠‡∏µ‡∏¢‡∏∞")) isShortened = true;
                
                if (!isShortened) return false; 
            }
            return true; 
        }

        function checkSamphus(word1, word2) {
            if (!word1 || !word2) return false;
            const sound1 = getVowelAndFinalSound(word1);
            const sound2 = getVowelAndFinalSound(word2);
            return sound1.vowel === sound2.vowel && sound1.finalGroup === sound2.finalGroup;
        }

        // ----------------------------------------------------
        // 2. TOKENIZER
        // ----------------------------------------------------
        
        const MANUAL_SPLITS = {
            "‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á": ["‡∏Ñ‡∏¥‡∏î", "‡∏ñ‡∏∂‡∏á"], "‡∏´‡∏±‡∏ß‡πÉ‡∏à": ["‡∏´‡∏±‡∏ß", "‡πÉ‡∏à"], "‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à": ["‡πÄ‡∏™‡∏µ‡∏¢", "‡πÉ‡∏à"], "‡∏î‡∏µ‡πÉ‡∏à": ["‡∏î‡∏µ", "‡πÉ‡∏à"],
            "‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à": ["‡πÄ‡∏Ç‡πâ‡∏≤", "‡πÉ‡∏à"], "‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à": ["‡∏°‡∏±‡πà‡∏ô", "‡πÉ‡∏à"], "‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à": ["‡∏†‡∏π‡∏°‡∏¥", "‡πÉ‡∏à"], "‡∏™‡∏∏‡∏Ç‡πÉ‡∏à": ["‡∏™‡∏∏‡∏Ç", "‡πÉ‡∏à"],
            "‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡πÉ‡∏à": ["‡∏ó‡∏∏‡∏Å‡∏Ç‡πå", "‡πÉ‡∏à"], "‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏à": ["‡∏ô‡πâ‡∏≠‡∏¢", "‡πÉ‡∏à"], "‡∏´‡πà‡∏ß‡∏á‡πÉ‡∏¢": ["‡∏´‡πà‡∏ß‡∏á", "‡πÉ‡∏¢"], "‡∏™‡∏ô‡πÉ‡∏à": ["‡∏™‡∏ô", "‡πÉ‡∏à"],
            "‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à": ["‡∏ï‡∏±‡πâ‡∏á", "‡πÉ‡∏à"], "‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏à": ["‡∏à‡∏£‡∏¥‡∏á", "‡πÉ‡∏à"], "‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏à": ["‡πÄ‡∏ï‡πá‡∏°", "‡πÉ‡∏à"], "‡∏ß‡∏≤‡∏á‡πÉ‡∏à": ["‡∏ß‡∏≤‡∏á", "‡πÉ‡∏à"],
            "‡∏ô‡πâ‡∏≥‡πÉ‡∏à": ["‡∏ô‡πâ‡∏≥", "‡πÉ‡∏à"], "‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ": ["‡∏£‡πâ‡∏≠‡∏á", "‡πÑ‡∏´‡πâ"], "‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏≤‡∏∞": ["‡∏´‡∏±‡∏ß", "‡πÄ‡∏£‡∏≤‡∏∞"], "‡∏¢‡∏¥‡πâ‡∏°‡πÅ‡∏¢‡πâ‡∏°": ["‡∏¢‡∏¥‡πâ‡∏°", "‡πÅ‡∏¢‡πâ‡∏°"],
            "‡∏™‡∏î‡πÉ‡∏™": ["‡∏™‡∏î", "‡πÉ‡∏™"], "‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï": ["‡∏ä‡∏µ", "‡∏ß‡∏¥‡∏ï"], "‡∏ä‡∏µ‡∏ß‡∏≤": ["‡∏ä‡∏µ", "‡∏ß‡∏≤"], "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å": ["‡∏Ñ‡∏ß‡∏≤‡∏°", "‡∏£‡∏±‡∏Å"],
            "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç": ["‡∏Ñ‡∏ß‡∏≤‡∏°", "‡∏™‡∏∏‡∏Ç"], "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∏‡∏Å‡∏Ç‡πå": ["‡∏Ñ‡∏ß‡∏≤‡∏°", "‡∏ó‡∏∏‡∏Å‡∏Ç‡πå"], "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô": ["‡πÇ‡∏£‡∏á", "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"],
            "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô": ["‡∏´‡πâ‡∏≠‡∏á", "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"], "‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô": ["‡∏ô‡∏±‡∏Å", "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"], "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π": ["‡∏Ñ‡∏∏‡∏ì", "‡∏Ñ‡∏£‡∏π"],
            "‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå": ["‡∏≠‡∏≤", "‡∏à‡∏≤‡∏£‡∏¢‡πå"], "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠": ["‡∏´‡∏ô‡∏±‡∏á", "‡∏™‡∏∑‡∏≠"], "‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤": ["‡∏õ‡∏≤‡∏Å", "‡∏Å‡∏≤"], "‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô": ["‡∏Å‡∏≤‡∏£", "‡∏ö‡πâ‡∏≤‡∏ô"],
            "‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö": ["‡∏Ç‡πâ‡∏≠", "‡∏™‡∏≠‡∏ö"], "‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏•": ["‡∏ü‡∏∏‡∏ï", "‡∏ö‡∏≠‡∏•"], "‡∏Å‡∏µ‡∏¨‡∏≤": ["‡∏Å‡∏µ", "‡∏¨‡∏≤"], "‡∏î‡∏ô‡∏ï‡∏£‡∏µ": ["‡∏î‡∏ô", "‡∏ï‡∏£‡∏µ"],
            "‡∏®‡∏¥‡∏•‡∏õ‡∏∞": ["‡∏®‡∏¥‡∏•", "‡∏õ‡∏∞"], "‡∏ß‡∏¥‡∏ä‡∏≤": ["‡∏ß‡∏¥", "‡∏ä‡∏≤"], "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ": ["‡∏Ñ‡∏ß‡∏≤‡∏°", "‡∏£‡∏π‡πâ"], "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ù‡∏π‡∏á": ["‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô", "‡∏ù‡∏π‡∏á"],
            "‡∏≠‡∏∞‡πÑ‡∏£": ["‡∏≠‡∏∞", "‡πÑ‡∏£"], "‡∏ó‡∏≥‡πÑ‡∏°": ["‡∏ó‡∏≥", "‡πÑ‡∏°"], "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏£": ["‡πÄ‡∏°‡∏∑‡πà‡∏≠", "‡πÑ‡∏£"], "‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£": ["‡πÄ‡∏ó‡πà‡∏≤", "‡πÑ‡∏£"],
            "‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£": ["‡∏≠‡∏¢‡πà‡∏≤‡∏á", "‡πÑ‡∏£"], "‡πÉ‡∏Ñ‡∏£‡πÉ‡∏Ñ‡∏£": ["‡πÉ‡∏Ñ‡∏£", "‡πÉ‡∏Ñ‡∏£"], "‡πÉ‡∏î‡πÉ‡∏î": ["‡πÉ‡∏î", "‡πÉ‡∏î"], "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ": ["‡∏ó‡∏±‡πà‡∏ß", "‡πÑ‡∏õ"],
            "‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤": ["‡∏Å‡πâ‡∏≤‡∏ß", "‡∏´‡∏ô‡πâ‡∏≤"], "‡∏Å‡πâ‡∏≤‡∏ß‡πÑ‡∏Å‡∏•": ["‡∏Å‡πâ‡∏≤‡∏ß", "‡πÑ‡∏Å‡∏•"], "‡∏´‡∏ß‡∏±‡πà‡∏ô‡πÑ‡∏´‡∏ß": ["‡∏´‡∏ß‡∏±‡πà‡∏ô", "‡πÑ‡∏´‡∏ß"], "‡∏≠‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß": ["‡∏≠‡πà‡∏≠‡∏ô", "‡πÑ‡∏´‡∏ß"],
            "‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏°‡πÉ‡∏™": ["‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏°", "‡πÉ‡∏™"], "‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™": ["‡πÇ‡∏õ‡∏£‡πà‡∏á", "‡πÉ‡∏™"], "‡∏™‡∏∏‡∏Å‡πÉ‡∏™": ["‡∏™‡∏∏‡∏Å", "‡πÉ‡∏™"], "‡∏≠‡∏≥‡πÑ‡∏û": ["‡∏≠‡∏≥", "‡πÑ‡∏û"],
            "‡∏ß‡∏¥‡πÑ‡∏•": ["‡∏ß‡∏¥", "‡πÑ‡∏•"], "‡πÄ‡∏â‡πÑ‡∏•": ["‡πÄ‡∏â", "‡πÑ‡∏•"], "‡∏£‡πà‡∏≥‡πÑ‡∏£": ["‡∏£‡πà‡∏≥", "‡πÑ‡∏£"], "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç": ["‡πÅ‡∏Å‡πâ", "‡πÑ‡∏Ç"],
            "‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç": ["‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô", "‡πÑ‡∏Ç"], "‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡πÑ‡∏°‡πâ": ["‡∏Å‡∏•‡πâ‡∏ß‡∏¢", "‡πÑ‡∏°‡πâ"], "‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ": ["‡∏ï‡πâ‡∏ô", "‡πÑ‡∏°‡πâ"], "‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ": ["‡∏î‡∏≠‡∏Å", "‡πÑ‡∏°‡πâ"],
            "‡∏ú‡∏•‡πÑ‡∏°‡πâ": ["‡∏ú‡∏•", "‡πÑ‡∏°‡πâ"], "‡∏£‡∏ñ‡πÑ‡∏ü": ["‡∏£‡∏ñ", "‡πÑ‡∏ü"], "‡πÑ‡∏ü‡∏ü‡πâ‡∏≤": ["‡πÑ‡∏ü", "‡∏ü‡πâ‡∏≤"],
            "‡∏™‡∏ö‡∏≤‡∏¢": ["‡∏™‡∏∞", "‡∏ö‡∏≤‡∏¢"], "‡∏™‡∏ô‡∏∏‡∏Å": ["‡∏™‡∏∞", "‡∏ô‡∏∏‡∏Å"], "‡∏™‡∏á‡∏ö": ["‡∏™‡∏∞", "‡∏á‡∏ö"], "‡∏™‡∏ß‡πà‡∏≤‡∏á": ["‡∏™‡∏∞", "‡∏ß‡πà‡∏≤‡∏á"],
            "‡πÑ‡∏™‡∏ß": ["‡∏™‡∏∞", "‡πÑ‡∏´‡∏ß"], "‡∏â‡∏•‡∏≤‡∏î": ["‡∏â‡∏∞", "‡∏´‡∏•‡∏≤‡∏î"], "‡∏ï‡∏•‡∏≤‡∏î": ["‡∏ï‡∏∞", "‡∏´‡∏•‡∏≤‡∏î"], "‡∏ï‡∏•‡∏Å": ["‡∏ï‡∏∞", "‡∏´‡∏•‡∏Å"],
            "‡∏ï‡∏•‡∏≠‡∏î": ["‡∏ï‡∏∞", "‡∏´‡∏•‡∏≠‡∏î"], "‡∏à‡∏£‡∏ß‡∏î": ["‡∏à‡∏∞", "‡∏£‡∏ß‡∏î"], "‡∏Ç‡∏ô‡∏°": ["‡∏Ç‡∏∞", "‡∏´‡∏ô‡∏°"], "‡∏ñ‡∏ô‡∏ô": ["‡∏ñ‡∏∞", "‡∏´‡∏ô‡∏ô"],
            "‡∏™‡∏¢‡∏≤‡∏°": ["‡∏™‡∏∞", "‡∏´‡∏¢‡∏≤‡∏°"], "‡∏™‡∏•‡∏ß‡∏¢": ["‡∏™‡∏∞", "‡∏•‡∏ß‡∏¢"], "‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô": ["‡∏™‡∏∞", "‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô"], "‡∏™‡∏ñ‡∏≤‡∏ô": ["‡∏™‡∏∞", "‡∏ñ‡∏≤‡∏ô"],
            "‡∏™‡∏ñ‡∏¥‡∏ï": ["‡∏™‡∏∞", "‡∏ñ‡∏¥‡∏î"], "‡∏™‡∏†‡∏≤‡∏û": ["‡∏™‡∏∞", "‡∏†‡∏≤‡∏û"], "‡πÄ‡∏â‡∏û‡∏≤‡∏∞": ["‡∏â‡∏∞", "‡πÄ‡∏û‡∏≤‡∏∞"], "‡πÄ‡∏ú‡∏≠‡∏¥‡∏ç": ["‡∏ú‡∏∞", "‡πÄ‡∏≠‡∏¥‡∏ç"],
            "‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç": ["‡∏ä‡∏≥", "‡∏ô‡∏≤‡∏ç"], "‡∏£‡∏≥‡∏Ñ‡∏≤‡∏ç": ["‡∏£‡∏≥", "‡∏Ñ‡∏≤‡∏ç"], "‡∏™‡∏≥‡∏£‡∏≤‡∏ç": ["‡∏™‡∏≥", "‡∏£‡∏≤‡∏ç"], "‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì": ["‡∏ß‡∏¥‡∏ô", "‡∏¢‡∏≤‡∏ô"],
            "‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì": ["‡∏™‡∏±‡∏ô", "‡∏¢‡∏≤‡∏ô"], "‡∏ö‡∏±‡∏ô‡∏î‡∏≤‡∏•": ["‡∏ö‡∏±‡∏ô", "‡∏î‡∏≤‡∏•"], "‡∏ö‡∏±‡∏ô‡πÑ‡∏î": ["‡∏ö‡∏±‡∏ô", "‡πÑ‡∏î"], "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å": ["‡∏ö‡∏±‡∏ô", "‡∏ó‡∏∂‡∏Å"],
            "‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå": ["‡∏™‡∏∞", "‡∏´‡∏ß‡∏±‡∏ô"], "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå": ["‡∏™‡∏£‡πâ‡∏≤‡∏á", "‡∏™‡∏£‡∏£‡∏Ñ‡πå"], "‡∏°‡∏´‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå": ["‡∏°‡∏∞", "‡∏´‡∏±‡∏î", "‡∏™‡∏∞", "‡∏à‡∏±‡∏ô"],
            "‡∏≠‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå": ["‡∏≠‡∏±‡∏î", "‡∏™‡∏∞", "‡∏à‡∏±‡∏ô"], "‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå": ["‡∏™‡∏±‡∏°", "‡∏û‡∏±‡∏ô"], "‡∏ú‡∏π‡∏Å‡∏û‡∏±‡∏ô": ["‡∏ú‡∏π‡∏Å", "‡∏û‡∏±‡∏ô"], "‡∏õ‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡πå": ["‡∏õ‡∏£‡∏∞", "‡∏û‡∏±‡∏ô‡∏ò‡πå"],
            "‡∏£‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå": ["‡∏£‡∏±‡∏á", "‡∏™‡∏£‡∏£‡∏Ñ‡πå"], "‡∏™‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå": ["‡∏™‡∏±‡∏á", "‡∏™‡∏£‡∏£‡∏Ñ‡πå"],
            "‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤": ["‡∏ó‡πâ‡∏≠‡∏á", "‡∏ü‡πâ‡∏≤"], "‡πÅ‡∏™‡∏á‡πÅ‡∏î‡∏î": ["‡πÅ‡∏™‡∏á", "‡πÅ‡∏î‡∏î"], "‡∏™‡∏≤‡∏¢‡∏•‡∏°": ["‡∏™‡∏≤‡∏¢", "‡∏•‡∏°"], "‡∏™‡∏≤‡∏¢‡∏ù‡∏ô": ["‡∏™‡∏≤‡∏¢", "‡∏ù‡∏ô"],
            "‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß": ["‡∏î‡∏ß‡∏á", "‡∏î‡∏≤‡∏ß"], "‡∏†‡∏π‡πÄ‡∏Ç‡∏≤": ["‡∏†‡∏π", "‡πÄ‡∏Ç‡∏≤"], "‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥": ["‡πÅ‡∏°‡πà", "‡∏ô‡πâ‡∏≥"], "‡∏ó‡∏∞‡πÄ‡∏•": ["‡∏ó‡∏∞", "‡πÄ‡∏•"],
            "‡πÄ‡∏ß‡∏•‡∏≤": ["‡πÄ‡∏ß", "‡∏•‡∏≤"], "‡∏ô‡∏≤‡∏ó‡∏µ": ["‡∏ô‡∏≤", "‡∏ó‡∏µ"], "‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á": ["‡∏ä‡∏±‡πà‡∏ß", "‡πÇ‡∏°‡∏á"], "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ": ["‡∏ß‡∏±‡∏ô", "‡∏ô‡∏µ‡πâ"],
            "‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ": ["‡∏û‡∏£‡∏∏‡πà‡∏á", "‡∏ô‡∏µ‡πâ"], "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô": ["‡πÄ‡∏°‡∏∑‡πà‡∏≠", "‡∏ß‡∏≤‡∏ô"], "‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà": ["‡∏õ‡∏µ", "‡πÉ‡∏´‡∏°‡πà"], "‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå": ["‡∏™‡∏á", "‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå"],
            "‡∏õ‡∏±‡∏ç‡∏´‡∏≤": ["‡∏õ‡∏±‡∏ô", "‡∏´‡∏≤"], "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à": ["‡∏™‡∏≥", "‡πÄ‡∏£‡πá‡∏à"], "‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß": ["‡∏•‡πâ‡∏°", "‡πÄ‡∏´‡∏•‡∏ß"], "‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ": ["‡πÇ‡∏ä‡∏Ñ", "‡∏î‡∏µ"],
            "‡πÇ‡∏ä‡∏Ñ‡∏£‡πâ‡∏≤‡∏¢": ["‡πÇ‡∏ä‡∏Ñ", "‡∏£‡πâ‡∏≤‡∏¢"], "‡πÇ‡∏≠‡∏Å‡∏≤‡∏™": ["‡πÇ‡∏≠", "‡∏Å‡∏≤‡∏™"], "‡∏û‡∏±‡∏í‡∏ô‡∏≤": ["‡∏û‡∏±‡∏ó", "‡∏ó‡∏∞", "‡∏ô‡∏≤"], "‡∏®‡∏∂‡∏Å‡∏©‡∏≤": ["‡∏®‡∏∂‡∏Å", "‡∏©‡∏≤"],
            "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ": ["‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏£‡∏π‡πâ"], "‡∏≠‡∏ö‡∏£‡∏°": ["‡∏≠‡∏ö", "‡∏£‡∏°"], "‡∏î‡∏π‡πÅ‡∏•": ["‡∏î‡∏π", "‡πÅ‡∏•"], "‡∏£‡∏±‡∏Å‡∏©‡∏≤": ["‡∏£‡∏±‡∏Å", "‡∏©‡∏≤"],
            "‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô": ["‡∏õ‡πâ‡∏≠‡∏á", "‡∏Å‡∏±‡∏ô"], "‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï": ["‡πÄ‡∏ï‡∏¥‡∏ö", "‡πÇ‡∏ï"]
        };

        function tokenizeLine(lineText) {
            lineText = lineText.replace(/[^\u0E00-\u0E7F\s]/g, " ");
            const segmenter = new Intl.Segmenter('th', { granularity: 'word' });
            const rawWords = Array.from(segmenter.segment(lineText)).filter(s => s.isWordLike).map(s => s.segment.trim());
            
            let finalSyllables = [];
            rawWords.forEach(word => {
                if (MANUAL_SPLITS[word]) {
                    finalSyllables.push(...MANUAL_SPLITS[word]);
                    return;
                }
                const piyaPattern = /^([‡∏Å-‡∏Æ][‡∏¥‡∏∏][‡∏Å-‡∏Æ]‡∏∞)$/;
                if (word.match(piyaPattern)) {
                    finalSyllables.push(word.substring(0,2), word.substring(2));
                    return;
                }
                const maliPattern = /^([‡∏Å-‡∏Æ]‡∏∞[‡∏Å-‡∏Æ][‡∏¥‡∏∏‡∏∞]?)$/;
                if (word.length > 2 && word.match(maliPattern)) {
                     finalSyllables.push(word.substring(0,2), word.substring(2));
                     return;
                }
                if (word.length > 2) {
                    let splitIndices = [];
                    for(let i=1; i<word.length; i++) if ("‡πÄ‡πÅ‡πÇ‡πÉ‡πÑ".includes(word[i])) splitIndices.push(i);
                    if (splitIndices.length > 0) {
                        let lastIdx = 0;
                        splitIndices.forEach(idx => {
                            finalSyllables.push(word.substring(lastIdx, idx));
                            lastIdx = idx;
                        });
                        finalSyllables.push(word.substring(lastIdx));
                    } else {
                        finalSyllables.push(word);
                    }
                } else {
                    finalSyllables.push(word);
                }
            });
            return finalSyllables;
        }

        // ----------------------------------------------------
        // 3. MAIN LOGIC (Line-by-Line)
        // ----------------------------------------------------

        const PATTERN_STANZA = [
            ['K', 'K', 'L', 'K', 'K'],          
            ['L', 'L', 'K', 'L', 'K', 'K'],     
            ['K', 'K', 'L', 'K', 'K'],          
            ['L', 'L', 'K', 'L', 'K', 'K']      
        ];

        function analyzePoem() {
            const input = document.getElementById('poemInput').value;
            if(!input.trim()) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏ö‡∏ó‡∏õ‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

            let rawLines = input.split(/\r?\n/).map(l => l.trim()).filter(l => l !== '');
            let mode = 1;
            if (rawLines.length > 6) mode = 2; 

            let currentPattern = (mode === 1) ? [...PATTERN_STANZA] : [...PATTERN_STANZA, ...PATTERN_STANZA];

            let structuredPoem = [];
            let extraWordsMap = [];

            for(let i = 0; i < currentPattern.length; i++) {
                let requiredPattern = currentPattern[i]; 
                let targetCount = requiredPattern.length;
                
                let userLineSyllables = [];
                if (i < rawLines.length) {
                    userLineSyllables = tokenizeLine(rawLines[i]);
                }

                let mainWords = [];
                let extraWords = [];

                if (userLineSyllables.length <= targetCount) {
                    mainWords = [...userLineSyllables];
                    while(mainWords.length < targetCount) {
                        mainWords.push("?"); 
                    }
                } else {
                    mainWords = userLineSyllables.slice(0, targetCount);
                    extraWords = userLineSyllables.slice(targetCount);
                }

                structuredPoem.push(mainWords);
                extraWordsMap.push(extraWords);
            }

            let rhymePairs = [
                { from: [0, 4], to: [1, 2], name: '‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏£‡∏£‡∏Ñ (‡∏ö‡∏ó 1)' },
                { from: [1, 5], to: [2, 4], name: '‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏≤‡∏ó (‡∏ö‡∏ó 1)' }
            ];
            if (mode === 2) {
                rhymePairs.push(
                    { from: [3, 5], to: [5, 5], name: '‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏ó' },
                    { from: [4, 4], to: [5, 2], name: '‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏£‡∏£‡∏Ñ (‡∏ö‡∏ó 2)' },
                    { from: [5, 5], to: [6, 4], name: '‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏≤‡∏ó (‡∏ö‡∏ó 2)' }
                );
            }

            renderResult(structuredPoem, extraWordsMap, currentPattern, rhymePairs, mode);
        }

        function renderResult(poem, extraWordsMap, pattern, rhymePairs, mode) {
            const resultArea = document.getElementById('resultArea');
            const visualDiv = document.getElementById('visualResult');
            const kruLahuSummary = document.getElementById('kruLahuSummary');
            const wordCountSummary = document.getElementById('wordCountSummary');
            const samphusSummary = document.getElementById('samphusSummary');
            
            visualDiv.innerHTML = '';
            resultArea.classList.remove('hidden');

            let errorKruLahuCount = 0;
            let missingWordCount = 0;
            let extraWordCount = 0;
            
            poem.forEach((verse, vIndex) => {
                const verseDiv = document.createElement('div');
                verseDiv.className = "flex flex-col md:flex-row md:items-center mb-6 border-b border-gray-100 pb-4";
                
                const label = document.createElement('div');
                label.className = "w-24 text-xs text-gray-500 font-bold uppercase tracking-wider mb-2 md:mb-0 flex-shrink-0";
                label.innerText = `‡∏ß‡∏£‡∏£‡∏Ñ ${vIndex + 1}`;
                verseDiv.appendChild(label);

                const contentContainer = document.createElement('div');
                contentContainer.className = "flex flex-wrap items-center gap-2";

                verse.forEach((word, wIndex) => {
                    const expected = pattern[vIndex][wIndex]; 
                    
                    const box = document.createElement('div');
                    
                    if(word === '?') {
                         box.className = "syllable-box empty-box";
                         box.innerHTML = `<span class="text-sm font-bold">‡∏Ç‡∏≤‡∏î</span>`;
                         missingWordCount++;
                    } else {
                        const isLahuWord = isLahu(word);
                        const actual = isLahuWord ? 'L' : 'K';
                        let bgClass = actual === 'K' ? 'kru-bg' : 'lahu-bg';
                        let isError = false;

                        if (expected === actual) {
                            box.className = `syllable-box ${bgClass}`;
                        } else {
                            box.className = `syllable-box bg-white border-2 border-red-500 text-red-600`;
                            isError = true;
                            errorKruLahuCount++;
                        }

                        box.innerHTML = `
                            <span class="syllable-word">${word}</span>
                            <span class="syllable-type">${actual==='K'?'‡∏Ñ‡∏£‡∏∏':'‡∏•‡∏´‡∏∏'}</span>
                            ${isError ? '<span class="badge badge-error">‡πÅ‡∏Å‡πâ</span>' : ''}
                        `;
                    }
                    contentContainer.appendChild(box);
                });

                const extras = extraWordsMap[vIndex];
                if (extras && extras.length > 0) {
                    const extraContainer = document.createElement('div');
                    extraContainer.className = "ml-4 pl-4 border-l-2 border-red-200";
                    extraContainer.innerHTML = `<span class="text-xs text-red-500 font-bold block mb-1">‡∏Ñ‡∏≥‡πÄ‡∏Å‡∏¥‡∏ô:</span>`;
                    
                    extras.forEach(w => {
                        extraWordCount++;
                        const sp = document.createElement('span');
                        sp.className = "extra-word";
                        sp.innerText = w;
                        extraContainer.appendChild(sp);
                    });
                    contentContainer.appendChild(extraContainer);
                }
                
                verseDiv.appendChild(contentContainer);
                visualDiv.appendChild(verseDiv);

                if (mode === 2 && vIndex === 3) {
                    const sep = document.createElement('div');
                    sep.className = "w-full border-b-2 border-dashed border-gray-300 my-6 text-center leading-none";
                    sep.innerHTML = "<span class='bg-gray-100 px-2 text-xs text-gray-500'>‡∏à‡∏ö ‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1</span>";
                    visualDiv.appendChild(sep);
                }
            });

            let rhymeHTML = '';
            rhymePairs.forEach(pair => {
                const w1 = poem[pair.from[0]]?.[pair.from[1]];
                const w2 = poem[pair.to[0]]?.[pair.to[1]];

                if(w1 && w2 && w1 !== '?' && w2 !== '?') {
                    const isRhyme = checkSamphus(w1, w2);
                    if(isRhyme) {
                        rhymeHTML += `<div class="flex items-center text-green-700 bg-green-50 p-2 rounded-lg border border-green-100 mb-1">
                            <span class="mr-2">‚úÖ</span> 
                            <span class="text-xs font-bold mr-2 border border-green-200 px-1 rounded text-green-600">${pair.name}</span>
                            <span><b>${w1}</b> - <b>${w2}</b> (‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™)</span>
                        </div>`;
                    } else {
                        rhymeHTML += `<div class="flex items-center text-red-700 bg-red-50 p-2 rounded-lg border border-red-100 mb-1">
                            <span class="mr-2">‚ùå</span> 
                             <span class="text-xs font-bold mr-2 border border-red-200 px-1 rounded text-red-500">${pair.name}</span>
                            <span><b>${w1}</b> - <b>${w2}</b> (‡πÑ‡∏°‡πà‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™)</span>
                        </div>`;
                    }
                } else {
                    rhymeHTML += `<div class="flex items-center text-gray-400 p-2 text-sm mb-1">
                        <span class="mr-2">‚ö™</span> ${pair.name}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
                    </div>`;
                }
            });
            samphusSummary.innerHTML = rhymeHTML;

            if (errorKruLahuCount === 0) {
                kruLahuSummary.innerHTML = `<h2 class="text-3xl font-bold text-green-500">‡∏ú‡πà‡∏≤‡∏ô!</h2><p class="text-gray-500 text-sm">‡∏â‡∏±‡∏ô‡∏ó‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå (‡∏Ñ‡∏£‡∏∏-‡∏•‡∏´‡∏∏) ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>`;
            } else {
                kruLahuSummary.innerHTML = `<h2 class="text-3xl font-bold text-red-500">${errorKruLahuCount} ‡∏à‡∏∏‡∏î</h2><p class="text-gray-500 text-sm">‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏Ñ‡∏£‡∏∏-‡∏•‡∏´‡∏∏</p>`;
            }

            let wordStatusHTML = '';
            if (missingWordCount === 0 && extraWordCount === 0) {
                wordStatusHTML = `<h2 class="text-3xl font-bold text-green-500">‡∏û‡∏≠‡∏î‡∏µ‡πÄ‡∏õ‡πä‡∏∞</h2><p class="text-gray-500 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>`;
            } else {
                if (missingWordCount > 0) wordStatusHTML += `<div class="text-yellow-600 font-bold">‚ö†Ô∏è ‡∏Ç‡∏≤‡∏î ${missingWordCount} ‡∏Ñ‡∏≥</div>`;
                if (extraWordCount > 0) wordStatusHTML += `<div class="text-red-600 font-bold">‚õî ‡πÄ‡∏Å‡∏¥‡∏ô ${extraWordCount} ‡∏Ñ‡∏≥</div>`;
            }
            wordCountSummary.innerHTML = wordStatusHTML;

            resultArea.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
