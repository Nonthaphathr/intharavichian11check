<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏â‡∏±‡∏ô‡∏ó‡πå ‡πë‡πë (V2.4 Complete)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Prompt', 'Sarabun', sans-serif; background-color: #f8f9fa; }
        .kru-bg { background-color: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .lahu-bg { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .syllable-box { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            width: 60px; 
            height: 65px; 
            margin: 4px; 
            border-radius: 8px;
            position: relative;
            transition: all 0.2s;
            background-color: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .syllable-word { font-size: 1.1rem; font-weight: 600; margin-bottom: 2px; }
        .syllable-type { font-size: 0.7rem; opacity: 0.8; }
        .error-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background-color: #ef4444;
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .logo-shadow { filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        
        /* Tip Box Animation */
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .tip-highlight { animation: pulse-soft 2s infinite; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div class="container max-w-4xl mx-auto p-4 flex-grow">
        
        <div class="bg-white rounded-2xl shadow-sm p-6 mb-6 text-center border border-gray-100 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-blue-600"></div>
            
            <div class="flex flex-col md:flex-row items-center justify-center gap-6 mb-4">
                <img src="https://img5.pic.in.th/file/secure-sv1/logo-vichakarngo-6.png" alt="Logo" class="w-32 h-auto rounded-lg logo-shadow object-contain">
                <div class="text-left">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏â‡∏±‡∏ô‡∏ó‡πå ‡πë‡πë</h1>
                    <p class="text-gray-500 mt-1">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏ó‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå (‡∏Ñ‡∏£‡∏∏-‡∏•‡∏´‡∏∏) ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™</p>
                    <div class="mt-2 inline-block bg-blue-50 text-blue-600 text-xs px-3 py-1 rounded-full border border-blue-100">
                        ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-6 mb-6 border border-gray-100">
            <label class="block text-gray-700 font-bold mb-2 flex flex-col md:flex-row md:items-center justify-between gap-2">
                <span class="flex items-center gap-2">‚úçÔ∏è ‡∏ß‡∏≤‡∏á‡∏ö‡∏ó‡∏õ‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡πå (1 ‡∏´‡∏£‡∏∑‡∏≠ 2 ‡∏ö‡∏ó)</span>
                <span class="text-xs font-normal text-gray-500 bg-gray-100 px-3 py-1 rounded-full">‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏Ñ‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ V2.4</span>
            </label>
            
            <textarea id="poemInput" rows="5" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 text-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" placeholder="‡∏ß‡∏≤‡∏á‡∏ö‡∏ó‡∏õ‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...&#10;‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏¥‡∏£‡∏µ‡∏ö‡∏•‡∏ô ‡∏Å‡πá‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏à‡∏∞‡∏á‡πà‡∏ß‡∏á‡∏ô‡∏≠‡∏ô&#10;‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πâ‡∏≠‡∏°‡πÄ‡∏ï‡∏∞‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏• ‡∏Å‡∏∞‡∏à‡∏∞‡πÄ‡∏Å‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç"></textarea>
            
            <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4 flex flex-col md:flex-row gap-4 items-start">
                <div class="flex-shrink-0 mt-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="flex-grow">
                    <h4 class="font-bold text-gray-800 text-sm mb-1">üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏´‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏û‡∏¢‡∏≤‡∏á‡∏Ñ‡πå‡∏ú‡∏¥‡∏î (‡∏£‡∏ß‡∏ö‡∏Ñ‡∏≥)</h4>
                    <p class="text-sm text-gray-600 mb-2">
                        ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏ß‡∏ö‡πÄ‡∏õ‡πá‡∏ô 1 ‡∏Ñ‡∏≥ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞) ‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô <b>"‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏ß‡∏£‡∏£‡∏Ñ"</b> ‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ô‡∏±‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å‡∏û‡∏¢‡∏≤‡∏á‡∏Ñ‡πå
                    </p>
                    <div class="bg-white border border-gray-200 rounded p-2 text-sm flex flex-wrap gap-4 items-center">
                        <div class="text-red-500 flex items-center gap-1">
                            <span>‚ùå ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏ß‡∏ö‡∏ú‡∏¥‡∏î:</span>
                            <span class="bg-gray-100 px-2 py-1 rounded border">‡∏ï‡∏≤‡∏Å‡∏•‡∏°</span>
                            <span class="text-xs text-gray-400">(‡∏ô‡∏±‡∏ö 1 ‡∏Ñ‡∏≥)</span>
                        </div>
                        <div class="text-gray-400">‚ûú</div>
                        <div class="text-green-600 flex items-center gap-1">
                            <span>‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ (‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏ß‡∏£‡∏£‡∏Ñ):</span>
                            <span class="bg-gray-100 px-2 py-1 rounded border ring-2 ring-green-100">‡∏ï‡∏≤ ‡∏Å‡∏•‡∏°</span>
                            <span class="text-xs text-gray-400">(‡∏ô‡∏±‡∏ö 2 ‡∏Ñ‡∏≥)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end mt-4">
                <button onclick="analyzePoem()" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-2 px-6 rounded-xl shadow-md transition transform hover:-translate-y-0.5 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏á‡∏≤‡∏ô
                </button>
            </div>
        </div>

        <div id="resultArea" class="hidden animate-fade-in-up">
            <div class="flex items-center gap-2 mb-4">
                <div class="w-1 h-8 bg-blue-600 rounded-full"></div>
                <h3 class="text-xl font-bold text-gray-800">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm">
                    <h4 class="font-bold text-gray-700 mb-2">‡∏ú‡∏±‡∏á‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö (‡∏Ñ‡∏£‡∏∏-‡∏•‡∏´‡∏∏)</h4>
                    <div id="kruLahuSummary"></div>
                </div>

                <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm">
                    <h4 class="font-bold text-gray-700 mb-2">‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö</h4>
                    <div id="samphusSummary" class="text-sm space-y-2"></div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm overflow-x-auto">
                <div id="visualResult" class="space-y-6 min-w-[600px]"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // 1. RULES & CHECKING LOGIC
        // ============================================

        function getVowelAndFinalSound(word) {
            if (!word) return { vowel: '', finalGroup: '' };
            const cleanWord = word.replace(/[‡πà‡πâ‡πä‡πã‡πå]/g, '');
            const processedWord = processLeadingConsonants(cleanWord);

            if (/‡∏£‡∏£[‡∏ñ‡∏ï‡∏©‡∏™‡∏®‡∏î‡∏à‡∏ä‡∏é‡∏è‡∏ê‡∏ë‡∏í‡∏ó‡∏ò]$/.test(processedWord)) return { vowel: '‡∏≠‡∏∞', finalGroup: '‡∏Å‡∏î' };
            if (/‡∏£‡∏£[‡∏Ñ‡∏Å‡∏Ç‡∏Ü]$/.test(processedWord)) return { vowel: '‡∏≠‡∏∞', finalGroup: '‡∏Å‡∏Å' };
            if (/‡∏£‡∏£[‡∏û‡∏†‡∏ö‡∏õ‡∏ü]$/.test(processedWord)) return { vowel: '‡∏≠‡∏∞', finalGroup: '‡∏Å‡∏ö' };
            if (processedWord.endsWith('‡∏£‡∏£‡∏°')) return { vowel: '‡∏≠‡∏≥', finalGroup: '‡∏Å‡∏Å‡∏≤' };
            if (processedWord.endsWith('‡∏£‡∏£')) return { vowel: '‡∏≠‡∏∞', finalGroup: '‡∏Å‡∏ô' };
            if (processedWord.endsWith('‡∏£‡∏£‡∏ì')) return { vowel: '‡∏≠‡∏∞', finalGroup: '‡∏Å‡∏ô' };

            if (hasAiVowel(processedWord)) return { vowel: '‡πÑ‡∏≠', finalGroup: '‡πÄ‡∏Å‡∏¢' };

            const finalGroup = getFinalConsonantGroup(processedWord);
            const vowel = getVowelSound(processedWord);
            return { vowel, finalGroup };
        }

        function processLeadingConsonants(word) {
            const anamYWords = ['‡∏≠‡∏¢‡πà‡∏≤', '‡∏≠‡∏¢‡∏π‡πà', '‡∏≠‡∏¢‡πà‡∏≤‡∏á', '‡∏≠‡∏¢‡∏≤‡∏Å'];
            for (let w of anamYWords) {
                if (word.startsWith(w.replace(/[‡πà‡πâ‡πä‡πã‡πå]/g, ''))) return '‡∏¢' + word.substring(2);
            }
            if (word.length >= 2 && word.charAt(0) === '‡∏´') {
                const secondChar = word.charAt(1);
                if (['‡∏á', '‡∏¢', '‡∏ç', '‡∏£', '‡∏ô', '‡∏•', '‡∏°', '‡∏ß'].includes(secondChar)) return word.substring(1);
            }
            return word;
        }

        function hasAiVowel(word) {
            if (word.includes('‡πÑ') || word.includes('‡πÉ') || word.includes('‡∏±‡∏¢')) return true;
            const specialAiWords = ['‡∏ß‡∏±‡∏¢', '‡∏ä‡∏±‡∏¢', '‡∏†‡∏±‡∏¢', '‡πÑ‡∏ó‡∏¢', '‡∏≠‡∏±‡∏¢', '‡∏Ç‡∏±‡∏¢', '‡∏ô‡∏±‡∏¢', '‡∏•‡∏±‡∏¢', '‡∏™‡∏±‡∏¢', '‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢', '‡∏≠‡∏≤‡∏®‡∏±‡∏¢', '‡∏ß‡∏¥‡∏™‡∏±‡∏¢', '‡∏õ‡∏£‡∏ô‡∏±‡∏¢', '‡∏≠‡∏∏‡∏õ‡∏±‡∏¢', '‡∏ß‡∏¥‡∏ò‡∏±‡∏¢'];
            for (let w of specialAiWords) {
                if (word === w || word.endsWith(w)) return true;
            }
            return false;
        }

        function getFinalConsonantGroup(word) {
            if (hasAiVowel(word)) return '‡πÄ‡∏Å‡∏¢';
            const lastChar = word.charAt(word.length - 1);
            const groups = {
                '‡∏Å‡∏Ç‡∏Ñ‡∏Ü': '‡∏Å‡∏Å', '‡∏à‡∏ä‡∏ã‡∏å‡∏ç‡∏î‡∏ï‡∏ñ‡∏ó‡∏ò‡∏®‡∏©‡∏™‡∏é‡∏è‡∏ê‡∏ë‡∏í': '‡∏Å‡∏î', '‡∏ö‡∏õ‡∏û‡∏ü‡∏†': '‡∏Å‡∏ö',
                '‡∏ô‡∏ì‡∏£‡∏•‡∏¨': '‡∏Å‡∏ô', '‡∏°': '‡∏Å‡∏°', '‡∏á': '‡∏Å‡∏á', '‡∏¢': '‡πÄ‡∏Å‡∏¢', '‡∏ß': '‡πÄ‡∏Å‡∏≠‡∏ß'
            };
            for (let g in groups) {
                if (g.includes(lastChar)) return groups[g];
            }
            return '‡∏Å‡∏Å‡∏≤';
        }

        function getVowelSound(word) {
            if (hasAiVowel(word)) return '‡πÑ‡∏≠';
            if (word.includes('‡∏≠‡∏≥') || word.includes('‡∏≥')) return '‡∏≠‡∏≥';
            const shortVowels = ['‡∏∞', '‡∏¥', '‡∏∂', '‡∏∏', '‡πá', '‡∏±'];
            for(let v of shortVowels) {
                 if(word.includes(v)) return '‡∏≠‡∏∞'; 
            }
            return '‡∏≠‡∏≤'; 
        }

        function isLahu(word) {
            if (!word) return false;
            word = word.trim();
            const cleanWord = word.replace(/[‡πà‡πâ‡πä‡πã‡πå]/g, '');
            const processedWord = processLeadingConsonants(cleanWord);
            
            // ‡∏Ñ‡∏≥‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏´‡∏∏
            const specialLahu = ["‡∏Å‡πá", "‡∏ö‡πà", "‡∏ì", "‡∏ò", "‡∏à‡∏∞", "‡∏ó‡∏¥", "‡∏õ‡∏¥", "‡∏¢‡∏∞", "‡∏™‡∏¥", "‡∏ò‡∏∏", "‡∏£‡∏∞", "‡∏û‡∏∞", "‡∏°‡∏¥", "‡∏î‡∏∏", "‡πÄ‡∏ï‡∏∞", "‡∏Å‡∏∞", "‡∏ô‡∏¥", "‡∏ú‡∏•‡∏¥", "‡∏•‡∏∏"];
            if (specialLahu.includes(word)) return true;

            if (processedWord.includes("‡∏≠‡∏≥") || processedWord.includes("‡πÑ‡∏≠") || processedWord.includes("‡πÉ‡∏≠") || processedWord.includes("‡πÄ‡∏≠‡∏≤")) return false;
            if (hasEndingConsonant(word)) return false;

            const forceKruLongVowels = ["‡∏≤", "‡∏µ", "‡∏∑", "‡∏π", "‡πÄ", "‡πÅ", "‡πÇ", "‡∏≠"];
            const shorteners = ["‡∏∞", "‡πá"];
            
            let hasLongVowel = false;
            for (let v of forceKruLongVowels) if (processedWord.includes(v)) hasLongVowel = true;

            if (hasLongVowel) {
                let isShortened = false;
                for (let s of shorteners) if (processedWord.includes(s)) isShortened = true;
                if (processedWord.includes("‡πÄ‡∏≠‡∏≤‡∏∞") || processedWord.includes("‡πÄ‡∏≠‡∏≠‡∏∞") || processedWord.includes("‡∏≠‡∏±‡∏ß‡∏∞") || processedWord.includes("‡πÄ‡∏≠‡∏µ‡∏¢‡∏∞")) isShortened = true;
                if (!isShortened) return false;
            }
            return true; 
        }

        function hasEndingConsonant(word) {
            const cleanWord = word.replace(/[‡πà‡πâ‡πä‡πã‡πå]/g, '');
            const processedWord = processLeadingConsonants(cleanWord);
            const finalConsonants = "‡∏Å‡∏Ç‡∏Ñ‡∏Ü‡∏à‡∏ä‡∏ã‡∏å‡∏ç‡∏î‡∏ï‡∏ñ‡∏ó‡∏ò‡∏®‡∏©‡∏™‡∏é‡∏è‡∏ê‡∏ö‡∏õ‡∏ú‡∏ù‡∏û‡∏ü‡∏†‡∏ô‡∏ì‡∏£‡∏•‡∏¨‡∏°‡∏¢‡∏ß‡∏á";
            const lastChar = processedWord.charAt(processedWord.length - 1);
            if (finalConsonants.includes(lastChar)) {
                if (processedWord.length === 1) return false;
                if ("‡πà‡πâ‡πä‡πã‡πå".includes(processedWord.charAt(processedWord.length - 2))) return false;
                return true;
            }
            return false;
        }

        function checkSamphus(word1, word2) {
            if (!word1 || !word2) return false;
            const sound1 = getVowelAndFinalSound(word1);
            const sound2 = getVowelAndFinalSound(word2);
            return sound1.vowel === sound2.vowel && sound1.finalGroup === sound2.finalGroup;
        }

        // ============================================
        // 2. INTELLIGENT SYLLABLE SPLITTER V2.4 (Dictionary Integration)
        // ============================================
        
        function tokenizeThaiSyllables(text) {
            // ‡∏•‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≤‡∏à‡πÄ‡∏Ñ‡∏≤‡∏∞‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≥‡πÄ‡∏≠‡∏á
            text = text.replace(/[^\u0E00-\u0E7F\s]/g, " ");
            
            const segmenter = new Intl.Segmenter('th', { granularity: 'word' });
            const rawWords = Array.from(segmenter.segment(text)).filter(s => s.isWordLike).map(s => s.segment.trim());

            // ‚ö†Ô∏è DICTIONARY ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏û‡∏¢‡∏≤‡∏á‡∏Ñ‡πå
            const MANUAL_SPLITS = {
                // --- ‡∏´‡∏°‡∏ß‡∏î 1: ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡πÄ‡∏à‡∏≠‡πÉ‡∏ô‡∏ö‡∏ó‡∏õ‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ---
                "‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á": ["‡∏Ñ‡∏¥‡∏î", "‡∏ñ‡∏∂‡∏á"],
                "‡∏´‡∏±‡∏ß‡πÉ‡∏à": ["‡∏´‡∏±‡∏ß", "‡πÉ‡∏à"],
                "‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à": ["‡πÄ‡∏™‡∏µ‡∏¢", "‡πÉ‡∏à"],
                "‡∏î‡∏µ‡πÉ‡∏à": ["‡∏î‡∏µ", "‡πÉ‡∏à"],
                "‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à": ["‡πÄ‡∏Ç‡πâ‡∏≤", "‡πÉ‡∏à"],
                "‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à": ["‡∏°‡∏±‡πà‡∏ô", "‡πÉ‡∏à"],
                "‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à": ["‡∏†‡∏π‡∏°‡∏¥", "‡πÉ‡∏à"],
                "‡∏™‡∏∏‡∏Ç‡πÉ‡∏à": ["‡∏™‡∏∏‡∏Ç", "‡πÉ‡∏à"],
                "‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡πÉ‡∏à": ["‡∏ó‡∏∏‡∏Å‡∏Ç‡πå", "‡πÉ‡∏à"],
                "‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏à": ["‡∏ô‡πâ‡∏≠‡∏¢", "‡πÉ‡∏à"],
                "‡∏´‡πà‡∏ß‡∏á‡πÉ‡∏¢": ["‡∏´‡πà‡∏ß‡∏á", "‡πÉ‡∏¢"],
                "‡∏™‡∏ô‡πÉ‡∏à": ["‡∏™‡∏ô", "‡πÉ‡∏à"],
                "‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à": ["‡∏ï‡∏±‡πâ‡∏á", "‡πÉ‡∏à"],
                "‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏à": ["‡∏à‡∏£‡∏¥‡∏á", "‡πÉ‡∏à"],
                "‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏à": ["‡πÄ‡∏ï‡πá‡∏°", "‡πÉ‡∏à"],
                "‡∏ß‡∏≤‡∏á‡πÉ‡∏à": ["‡∏ß‡∏≤‡∏á", "‡πÉ‡∏à"],
                "‡∏ô‡πâ‡∏≥‡πÉ‡∏à": ["‡∏ô‡πâ‡∏≥", "‡πÉ‡∏à"],
                "‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ": ["‡∏£‡πâ‡∏≠‡∏á", "‡πÑ‡∏´‡πâ"],
                "‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏≤‡∏∞": ["‡∏´‡∏±‡∏ß", "‡πÄ‡∏£‡∏≤‡∏∞"],
                "‡∏¢‡∏¥‡πâ‡∏°‡πÅ‡∏¢‡πâ‡∏°": ["‡∏¢‡∏¥‡πâ‡∏°", "‡πÅ‡∏¢‡πâ‡∏°"],
                "‡∏™‡∏î‡πÉ‡∏™": ["‡∏™‡∏î", "‡πÉ‡∏™"],
                "‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï": ["‡∏ä‡∏µ", "‡∏ß‡∏¥‡∏ï"],
                "‡∏ä‡∏µ‡∏ß‡∏≤": ["‡∏ä‡∏µ", "‡∏ß‡∏≤"],
                "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å": ["‡∏Ñ‡∏ß‡∏≤‡∏°", "‡∏£‡∏±‡∏Å"],
                "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç": ["‡∏Ñ‡∏ß‡∏≤‡∏°", "‡∏™‡∏∏‡∏Ç"],
                "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∏‡∏Å‡∏Ç‡πå": ["‡∏Ñ‡∏ß‡∏≤‡∏°", "‡∏ó‡∏∏‡∏Å‡∏Ç‡πå"],
                "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô": ["‡πÇ‡∏£‡∏á", "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"],
                "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô": ["‡∏´‡πâ‡∏≠‡∏á", "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"],
                "‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô": ["‡∏ô‡∏±‡∏Å", "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"],
                "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π": ["‡∏Ñ‡∏∏‡∏ì", "‡∏Ñ‡∏£‡∏π"],
                "‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå": ["‡∏≠‡∏≤", "‡∏à‡∏≤‡∏£‡∏¢‡πå"],
                "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠": ["‡∏´‡∏ô‡∏±‡∏á", "‡∏™‡∏∑‡∏≠"],
                "‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤": ["‡∏õ‡∏≤‡∏Å", "‡∏Å‡∏≤"],
                "‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô": ["‡∏Å‡∏≤‡∏£", "‡∏ö‡πâ‡∏≤‡∏ô"],
                "‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö": ["‡∏Ç‡πâ‡∏≠", "‡∏™‡∏≠‡∏ö"],
                "‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏•": ["‡∏ü‡∏∏‡∏ï", "‡∏ö‡∏≠‡∏•"],
                "‡∏Å‡∏µ‡∏¨‡∏≤": ["‡∏Å‡∏µ", "‡∏¨‡∏≤"],
                "‡∏î‡∏ô‡∏ï‡∏£‡∏µ": ["‡∏î‡∏ô", "‡∏ï‡∏£‡∏µ"],
                "‡∏®‡∏¥‡∏•‡∏õ‡∏∞": ["‡∏®‡∏¥‡∏•", "‡∏õ‡∏∞"],
                "‡∏ß‡∏¥‡∏ä‡∏≤": ["‡∏ß‡∏¥", "‡∏ä‡∏≤"],
                "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ": ["‡∏Ñ‡∏ß‡∏≤‡∏°", "‡∏£‡∏π‡πâ"],
                "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ù‡∏π‡∏á": ["‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô", "‡∏ù‡∏π‡∏á"],

                // --- ‡∏´‡∏°‡∏ß‡∏î 2: ‡∏Ñ‡∏≥‡∏™‡∏£‡∏∞‡∏ô‡∏≥ ---
                "‡∏≠‡∏∞‡πÑ‡∏£": ["‡∏≠‡∏∞", "‡πÑ‡∏£"],
                "‡∏ó‡∏≥‡πÑ‡∏°": ["‡∏ó‡∏≥", "‡πÑ‡∏°"],
                "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏£": ["‡πÄ‡∏°‡∏∑‡πà‡∏≠", "‡πÑ‡∏£"],
                "‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£": ["‡πÄ‡∏ó‡πà‡∏≤", "‡πÑ‡∏£"],
                "‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£": ["‡∏≠‡∏¢‡πà‡∏≤‡∏á", "‡πÑ‡∏£"],
                "‡πÉ‡∏Ñ‡∏£‡πÉ‡∏Ñ‡∏£": ["‡πÉ‡∏Ñ‡∏£", "‡πÉ‡∏Ñ‡∏£"],
                "‡πÉ‡∏î‡πÉ‡∏î": ["‡πÉ‡∏î", "‡πÉ‡∏î"],
                "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ": ["‡∏ó‡∏±‡πà‡∏ß", "‡πÑ‡∏õ"],
                "‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤": ["‡∏Å‡πâ‡∏≤‡∏ß", "‡∏´‡∏ô‡πâ‡∏≤"],
                "‡∏Å‡πâ‡∏≤‡∏ß‡πÑ‡∏Å‡∏•": ["‡∏Å‡πâ‡∏≤‡∏ß", "‡πÑ‡∏Å‡∏•"],
                "‡∏´‡∏ß‡∏±‡πà‡∏ô‡πÑ‡∏´‡∏ß": ["‡∏´‡∏ß‡∏±‡πà‡∏ô", "‡πÑ‡∏´‡∏ß"],
                "‡∏≠‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß": ["‡∏≠‡πà‡∏≠‡∏ô", "‡πÑ‡∏´‡∏ß"],
                "‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏°‡πÉ‡∏™": ["‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏°", "‡πÉ‡∏™"],
                "‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™": ["‡πÇ‡∏õ‡∏£‡πà‡∏á", "‡πÉ‡∏™"],
                "‡∏™‡∏∏‡∏Å‡πÉ‡∏™": ["‡∏™‡∏∏‡∏Å", "‡πÉ‡∏™"],
                "‡∏≠‡∏≥‡πÑ‡∏û": ["‡∏≠‡∏≥", "‡πÑ‡∏û"],
                "‡∏ß‡∏¥‡πÑ‡∏•": ["‡∏ß‡∏¥", "‡πÑ‡∏•"],
                "‡πÄ‡∏â‡πÑ‡∏•": ["‡πÄ‡∏â", "‡πÑ‡∏•"],
                "‡∏£‡πà‡∏≥‡πÑ‡∏£": ["‡∏£‡πà‡∏≥", "‡πÑ‡∏£"],
                "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç": ["‡πÅ‡∏Å‡πâ", "‡πÑ‡∏Ç"],
                "‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç": ["‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô", "‡πÑ‡∏Ç"],
                "‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡πÑ‡∏°‡πâ": ["‡∏Å‡∏•‡πâ‡∏ß‡∏¢", "‡πÑ‡∏°‡πâ"],
                "‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ": ["‡∏ï‡πâ‡∏ô", "‡πÑ‡∏°‡πâ"],
                "‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ": ["‡∏î‡∏≠‡∏Å", "‡πÑ‡∏°‡πâ"],
                "‡∏ú‡∏•‡πÑ‡∏°‡πâ": ["‡∏ú‡∏•", "‡πÑ‡∏°‡πâ"],
                "‡∏£‡∏ñ‡πÑ‡∏ü": ["‡∏£‡∏ñ", "‡πÑ‡∏ü"],
                "‡πÑ‡∏ü‡∏ü‡πâ‡∏≤": ["‡πÑ‡∏ü", "‡∏ü‡πâ‡∏≤"],

                // --- ‡∏´‡∏°‡∏ß‡∏î 3: ‡∏Ñ‡∏≥‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ô‡∏≥ / ‡∏™‡∏£‡∏∞‡∏•‡∏î‡∏£‡∏π‡∏õ ---
                "‡∏™‡∏ö‡∏≤‡∏¢": ["‡∏™‡∏∞", "‡∏ö‡∏≤‡∏¢"],
                "‡∏™‡∏ô‡∏∏‡∏Å": ["‡∏™‡∏∞", "‡∏ô‡∏∏‡∏Å"],
                "‡∏™‡∏á‡∏ö": ["‡∏™‡∏∞", "‡∏á‡∏ö"],
                "‡∏™‡∏ß‡πà‡∏≤‡∏á": ["‡∏™‡∏∞", "‡∏ß‡πà‡∏≤‡∏á"],
                "‡πÑ‡∏™‡∏ß": ["‡∏™‡∏∞", "‡πÑ‡∏´‡∏ß"],
                "‡∏â‡∏•‡∏≤‡∏î": ["‡∏â‡∏∞", "‡∏´‡∏•‡∏≤‡∏î"],
                "‡∏ï‡∏•‡∏≤‡∏î": ["‡∏ï‡∏∞", "‡∏´‡∏•‡∏≤‡∏î"],
                "‡∏ï‡∏•‡∏Å": ["‡∏ï‡∏∞", "‡∏´‡∏•‡∏Å"],
                "‡∏ï‡∏•‡∏≠‡∏î": ["‡∏ï‡∏∞", "‡∏´‡∏•‡∏≠‡∏î"],
                "‡∏à‡∏£‡∏ß‡∏î": ["‡∏à‡∏∞", "‡∏£‡∏ß‡∏î"],
                "‡∏Ç‡∏ô‡∏°": ["‡∏Ç‡∏∞", "‡∏´‡∏ô‡∏°"],
                "‡∏ñ‡∏ô‡∏ô": ["‡∏ñ‡∏∞", "‡∏´‡∏ô‡∏ô"],
                "‡∏™‡∏¢‡∏≤‡∏°": ["‡∏™‡∏∞", "‡∏´‡∏¢‡∏≤‡∏°"],
                "‡∏™‡∏•‡∏ß‡∏¢": ["‡∏™‡∏∞", "‡∏•‡∏ß‡∏¢"],
                "‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô": ["‡∏™‡∏∞", "‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô"],
                "‡∏™‡∏ñ‡∏≤‡∏ô": ["‡∏™‡∏∞", "‡∏ñ‡∏≤‡∏ô"],
                "‡∏™‡∏ñ‡∏¥‡∏ï": ["‡∏™‡∏∞", "‡∏ñ‡∏¥‡∏î"],
                "‡∏™‡∏†‡∏≤‡∏û": ["‡∏™‡∏∞", "‡∏†‡∏≤‡∏û"],
                "‡πÄ‡∏â‡∏û‡∏≤‡∏∞": ["‡∏â‡∏∞", "‡πÄ‡∏û‡∏≤‡∏∞"],
                "‡πÄ‡∏ú‡∏≠‡∏¥‡∏ç": ["‡∏ú‡∏∞", "‡πÄ‡∏≠‡∏¥‡∏ç"],

                // --- ‡∏´‡∏°‡∏ß‡∏î 4: ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏™‡∏∞‡∏Å‡∏î/‡∏ï‡∏±‡∏ß‡∏Å‡∏≤‡∏£‡∏±‡∏ô‡∏ï‡πå ---
                "‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç": ["‡∏ä‡∏≥", "‡∏ô‡∏≤‡∏ç"],
                "‡∏£‡∏≥‡∏Ñ‡∏≤‡∏ç": ["‡∏£‡∏≥", "‡∏Ñ‡∏≤‡∏ç"],
                "‡∏™‡∏≥‡∏£‡∏≤‡∏ç": ["‡∏™‡∏≥", "‡∏£‡∏≤‡∏ç"],
                "‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì": ["‡∏ß‡∏¥‡∏ô", "‡∏¢‡∏≤‡∏ô"],
                "‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì": ["‡∏™‡∏±‡∏ô", "‡∏¢‡∏≤‡∏ô"],
                "‡∏ö‡∏±‡∏ô‡∏î‡∏≤‡∏•": ["‡∏ö‡∏±‡∏ô", "‡∏î‡∏≤‡∏•"],
                "‡∏ö‡∏±‡∏ô‡πÑ‡∏î": ["‡∏ö‡∏±‡∏ô", "‡πÑ‡∏î"],
                "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å": ["‡∏ö‡∏±‡∏ô", "‡∏ó‡∏∂‡∏Å"],
                "‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå": ["‡∏™‡∏∞", "‡∏´‡∏ß‡∏±‡∏ô"],
                "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå": ["‡∏™‡∏£‡πâ‡∏≤‡∏á", "‡∏™‡∏£‡∏£‡∏Ñ‡πå"],
                "‡∏°‡∏´‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå": ["‡∏°‡∏∞", "‡∏´‡∏±‡∏î", "‡∏™‡∏∞", "‡∏à‡∏±‡∏ô"],
                "‡∏≠‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå": ["‡∏≠‡∏±‡∏î", "‡∏™‡∏∞", "‡∏à‡∏±‡∏ô"],
                "‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå": ["‡∏™‡∏±‡∏°", "‡∏û‡∏±‡∏ô"],
                "‡∏ú‡∏π‡∏Å‡∏û‡∏±‡∏ô": ["‡∏ú‡∏π‡∏Å", "‡∏û‡∏±‡∏ô"],
                "‡∏õ‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡πå": ["‡∏õ‡∏£‡∏∞", "‡∏û‡∏±‡∏ô‡∏ò‡πå"],
                "‡∏£‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå": ["‡∏£‡∏±‡∏á", "‡∏™‡∏£‡∏£‡∏Ñ‡πå"],
                "‡∏™‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå": ["‡∏™‡∏±‡∏á", "‡∏™‡∏£‡∏£‡∏Ñ‡πå"],

                // --- ‡∏´‡∏°‡∏ß‡∏î 5: ‡∏Ñ‡∏≥‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥/‡πÄ‡∏ß‡∏•‡∏≤ ---
                "‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤": ["‡∏ó‡πâ‡∏≠‡∏á", "‡∏ü‡πâ‡∏≤"],
                "‡πÅ‡∏™‡∏á‡πÅ‡∏î‡∏î": ["‡πÅ‡∏™‡∏á", "‡πÅ‡∏î‡∏î"],
                "‡∏™‡∏≤‡∏¢‡∏•‡∏°": ["‡∏™‡∏≤‡∏¢", "‡∏•‡∏°"],
                "‡∏™‡∏≤‡∏¢‡∏ù‡∏ô": ["‡∏™‡∏≤‡∏¢", "‡∏ù‡∏ô"],
                "‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß": ["‡∏î‡∏ß‡∏á", "‡∏î‡∏≤‡∏ß"],
                "‡∏†‡∏π‡πÄ‡∏Ç‡∏≤": ["‡∏†‡∏π", "‡πÄ‡∏Ç‡∏≤"],
                "‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥": ["‡πÅ‡∏°‡πà", "‡∏ô‡πâ‡∏≥"],
                "‡∏ó‡∏∞‡πÄ‡∏•": ["‡∏ó‡∏∞", "‡πÄ‡∏•"],
                "‡πÄ‡∏ß‡∏•‡∏≤": ["‡πÄ‡∏ß", "‡∏•‡∏≤"],
                "‡∏ô‡∏≤‡∏ó‡∏µ": ["‡∏ô‡∏≤", "‡∏ó‡∏µ"],
                "‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á": ["‡∏ä‡∏±‡πà‡∏ß", "‡πÇ‡∏°‡∏á"],
                "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ": ["‡∏ß‡∏±‡∏ô", "‡∏ô‡∏µ‡πâ"],
                "‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ": ["‡∏û‡∏£‡∏∏‡πà‡∏á", "‡∏ô‡∏µ‡πâ"],
                "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô": ["‡πÄ‡∏°‡∏∑‡πà‡∏≠", "‡∏ß‡∏≤‡∏ô"],
                "‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà": ["‡∏õ‡∏µ", "‡πÉ‡∏´‡∏°‡πà"],
                "‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå": ["‡∏™‡∏á", "‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå"],

                // --- ‡∏´‡∏°‡∏ß‡∏î 6: ‡∏Ñ‡∏≥‡∏Å‡∏£‡∏¥‡∏¢‡∏≤/‡∏ô‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ---
                "‡∏õ‡∏±‡∏ç‡∏´‡∏≤": ["‡∏õ‡∏±‡∏ô", "‡∏´‡∏≤"],
                "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à": ["‡∏™‡∏≥", "‡πÄ‡∏£‡πá‡∏à"],
                "‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß": ["‡∏•‡πâ‡∏°", "‡πÄ‡∏´‡∏•‡∏ß"],
                "‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ": ["‡πÇ‡∏ä‡∏Ñ", "‡∏î‡∏µ"],
                "‡πÇ‡∏ä‡∏Ñ‡∏£‡πâ‡∏≤‡∏¢": ["‡πÇ‡∏ä‡∏Ñ", "‡∏£‡πâ‡∏≤‡∏¢"],
                "‡πÇ‡∏≠‡∏Å‡∏≤‡∏™": ["‡πÇ‡∏≠", "‡∏Å‡∏≤‡∏™"],
                "‡∏û‡∏±‡∏í‡∏ô‡∏≤": ["‡∏û‡∏±‡∏ó", "‡∏ó‡∏∞", "‡∏ô‡∏≤"],
                "‡∏®‡∏∂‡∏Å‡∏©‡∏≤": ["‡∏®‡∏∂‡∏Å", "‡∏©‡∏≤"],
                "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ": ["‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏£‡∏π‡πâ"],
                "‡∏≠‡∏ö‡∏£‡∏°": ["‡∏≠‡∏ö", "‡∏£‡∏°"],
                "‡∏î‡∏π‡πÅ‡∏•": ["‡∏î‡∏π", "‡πÅ‡∏•"],
                "‡∏£‡∏±‡∏Å‡∏©‡∏≤": ["‡∏£‡∏±‡∏Å", "‡∏©‡∏≤"],
                "‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô": ["‡∏õ‡πâ‡∏≠‡∏á", "‡∏Å‡∏±‡∏ô"],
                "‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï": ["‡πÄ‡∏ï‡∏¥‡∏ö", "‡πÇ‡∏ï"]
            };

            let finalSyllables = [];

            rawWords.forEach(word => {
                // A. ‡πÄ‡∏ä‡πá‡∏Ñ Dictionary
                if (MANUAL_SPLITS[word]) {
                    finalSyllables.push(...MANUAL_SPLITS[word]);
                    return;
                }

                // B. ‡πÄ‡∏ä‡πá‡∏Ñ Pattern "‡∏õ‡∏¥‡∏¢‡∏∞"
                const piyaPattern = /^([‡∏Å-‡∏Æ][‡∏¥‡∏∏][‡∏Å-‡∏Æ]‡∏∞)$/;
                if (word.match(piyaPattern)) {
                    finalSyllables.push(word.substring(0,2));
                    finalSyllables.push(word.substring(2));
                    return;
                }

                // C. ‡πÄ‡∏ä‡πá‡∏Ñ Pattern "‡∏Å‡∏∞‡∏ó‡∏¥"
                const maliPattern = /^([‡∏Å-‡∏Æ]‡∏∞[‡∏Å-‡∏Æ][‡∏¥‡∏∏‡∏∞]?)$/;
                if (word.length > 2 && word.match(maliPattern)) {
                     finalSyllables.push(word.substring(0,2));
                     finalSyllables.push(word.substring(2));
                     return;
                }

                // D. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏£‡∏∞‡∏ô‡∏≥‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏≥ (‡πÄ ‡πÅ ‡πÇ ‡πÉ ‡πÑ)
                if (word.length > 2) {
                    let splitIndices = [];
                    for(let i=1; i<word.length; i++) {
                        if ("‡πÄ‡πÅ‡πÇ‡πÉ‡πÑ".includes(word[i])) {
                            splitIndices.push(i);
                        }
                    }

                    if (splitIndices.length > 0) {
                        let lastIdx = 0;
                        splitIndices.forEach(idx => {
                            finalSyllables.push(word.substring(lastIdx, idx));
                            lastIdx = idx;
                        });
                        finalSyllables.push(word.substring(lastIdx));
                    } else {
                        finalSyllables.push(word);
                    }
                } else {
                    finalSyllables.push(word);
                }
            });

            return finalSyllables;
        }

        // ============================================
        // 3. MAIN APP LOGIC
        // ============================================

        const PATTERN_STANZA = [
            ['K', 'K', 'L', 'K', 'K'],          // ‡∏ß‡∏£‡∏£‡∏Ñ 1
            ['L', 'L', 'K', 'L', 'K', 'K'],     // ‡∏ß‡∏£‡∏£‡∏Ñ 2
            ['K', 'K', 'L', 'K', 'K'],          // ‡∏ß‡∏£‡∏£‡∏Ñ 3
            ['L', 'L', 'K', 'L', 'K', 'K']      // ‡∏ß‡∏£‡∏£‡∏Ñ 4
        ];

        function analyzePoem() {
            const input = document.getElementById('poemInput').value.trim();
            if(!input) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏ö‡∏ó‡∏õ‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

            let syllables = tokenizeThaiSyllables(input);
            const count = syllables.length;
            let mode = 1; 
            
            if (count > 30) mode = 2; 

            let currentPattern = [];
            if (mode === 1) {
                currentPattern = [...PATTERN_STANZA];
            } else {
                currentPattern = [...PATTERN_STANZA, ...PATTERN_STANZA];
            }

            let structuredPoem = [];
            let wordIndex = 0;
            
            for(let i=0; i < currentPattern.length; i++) {
                let versePattern = currentPattern[i];
                let verseWords = [];
                for(let j=0; j < versePattern.length; j++) {
                    if(wordIndex < syllables.length) {
                        verseWords.push(syllables[wordIndex]);
                        wordIndex++;
                    } else {
                        verseWords.push("?"); 
                    }
                }
                structuredPoem.push(verseWords);
            }

            let rhymePairs = [
                { from: [0, 4], to: [1, 2], name: '‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏£‡∏£‡∏Ñ (‡∏ö‡∏ó 1)' },
                { from: [1, 5], to: [2, 4], name: '‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏≤‡∏ó (‡∏ö‡∏ó 1)' }
            ];

            if (mode === 2) {
                rhymePairs.push(
                    { from: [3, 5], to: [5, 5], name: '‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏ó' },
                    { from: [4, 4], to: [5, 2], name: '‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏£‡∏£‡∏Ñ (‡∏ö‡∏ó 2)' },
                    { from: [5, 5], to: [6, 4], name: '‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏≤‡∏ó (‡∏ö‡∏ó 2)' }
                );
            }

            renderResult(structuredPoem, currentPattern, rhymePairs, mode);
        }

        function renderResult(poem, pattern, rhymePairs, mode) {
            const resultArea = document.getElementById('resultArea');
            const visualDiv = document.getElementById('visualResult');
            const kruLahuSummary = document.getElementById('kruLahuSummary');
            const samphusSummary = document.getElementById('samphusSummary');
            
            visualDiv.innerHTML = '';
            resultArea.classList.remove('hidden');

            let errorCount = 0;
            
            poem.forEach((verse, vIndex) => {
                const verseDiv = document.createElement('div');
                verseDiv.className = "flex items-center mb-4";
                
                const label = document.createElement('div');
                label.className = "w-20 text-xs text-gray-400 font-bold uppercase tracking-wider flex-shrink-0";
                label.innerText = `‡∏ß‡∏£‡∏£‡∏Ñ ${vIndex + 1}`;
                verseDiv.appendChild(label);

                const wordsContainer = document.createElement('div');
                wordsContainer.className = "flex flex-wrap gap-2";

                verse.forEach((word, wIndex) => {
                    const expected = pattern[vIndex][wIndex]; 
                    const isLahuWord = isLahu(word);
                    const actual = isLahuWord ? 'L' : 'K';
                    
                    const box = document.createElement('div');
                    
                    let bgClass = actual === 'K' ? 'kru-bg' : 'lahu-bg';
                    let isError = false;

                    if(word === '?') {
                         box.className = "syllable-box bg-gray-100 text-gray-400 border border-gray-200";
                         word = "‡∏ß‡πà‡∏≤‡∏á";
                    } else if (expected === actual) {
                        box.className = `syllable-box ${bgClass}`;
                    } else {
                        box.className = `syllable-box bg-white border-2 border-red-500 text-red-600`;
                        isError = true;
                        errorCount++;
                    }

                    box.innerHTML = `
                        <span class="syllable-word">${word}</span>
                        <span class="syllable-type">${actual==='K'?'‡∏Ñ‡∏£‡∏∏':'‡∏•‡∏´‡∏∏'}</span>
                        ${isError ? '<span class="error-badge">‡πÅ‡∏Å‡πâ</span>' : ''}
                    `;
                    wordsContainer.appendChild(box);
                });
                
                verseDiv.appendChild(wordsContainer);
                visualDiv.appendChild(verseDiv);

                if (mode === 2 && vIndex === 3) {
                    const sep = document.createElement('div');
                    sep.className = "border-b border-dashed border-gray-300 my-4 mx-10";
                    visualDiv.appendChild(sep);
                }
            });

            let rhymeHTML = '';
            rhymePairs.forEach(pair => {
                const w1 = poem[pair.from[0]]?.[pair.from[1]];
                const w2 = poem[pair.to[0]]?.[pair.to[1]];

                if(w1 && w2 && w1 !== '?' && w2 !== '?') {
                    const isRhyme = checkSamphus(w1, w2);
                    if(isRhyme) {
                        rhymeHTML += `<div class="flex items-center text-green-700 bg-green-50 p-2 rounded-lg border border-green-100">
                            <span class="mr-2">‚úÖ</span> 
                            <span class="text-xs font-bold mr-2 border border-green-200 px-1 rounded text-green-600">${pair.name}</span>
                            <span><b>${w1}</b> - <b>${w2}</b> (‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™)</span>
                        </div>`;
                    } else {
                        rhymeHTML += `<div class="flex items-center text-red-700 bg-red-50 p-2 rounded-lg border border-red-100">
                            <span class="mr-2">‚ùå</span> 
                             <span class="text-xs font-bold mr-2 border border-red-200 px-1 rounded text-red-500">${pair.name}</span>
                            <span><b>${w1}</b> - <b>${w2}</b> (‡πÑ‡∏°‡πà‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™)</span>
                        </div>`;
                    }
                } else {
                    rhymeHTML += `<div class="flex items-center text-gray-400 p-2 text-sm">
                        <span class="mr-2">‚ö™</span> ${pair.name}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
                    </div>`;
                }
            });
            samphusSummary.innerHTML = rhymeHTML;

            if (errorCount === 0) {
                kruLahuSummary.innerHTML = `<h2 class="text-3xl font-bold text-green-500">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å!</h2><p class="text-gray-500 text-sm">‡∏â‡∏±‡∏ô‡∏ó‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (${mode} ‡∏ö‡∏ó)</p>`;
            } else {
                kruLahuSummary.innerHTML = `<h2 class="text-3xl font-bold text-red-500">‡∏û‡∏ö ${errorCount} ‡∏à‡∏∏‡∏î</h2><p class="text-gray-500 text-sm">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå "‡πÅ‡∏Å‡πâ"</p>`;
            }

            resultArea.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
